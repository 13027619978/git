<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/gzhTickets.css?v=1.0.0">
		<style type="text/css">
			.timeBtn.disabled{
				background-color: #F0F0F0;
				color: #666;
			}
			.timeBtn{
				margin: 5px 0;
			}
			.kcTxt{
				font-size: 12px;
				color: #8D8D8D;
			}
		</style>
		<title>摆渡船购票</title>
	</head>
	<body>
		<div class="container">
			<!-- 购买界面 -->
			<div class="shopView">
				<div class="shopContent">
					<a class="closeBtn" href="javascript:;" onclick="closeClick()">
						<img src="img/close.png" >
					</a>
					<div class="shopContentView">
						<div class="shopTop">
							<div class="shopImg">
								<img src="img/snx/snx1.jpg">
							</div>
							<div class="shopPrice">
								<p class="priceTxt">¥80</p>
								<p class="kcTxt">库存：40</p>
							</div>
						</div>
						
						<div class="ggContent">
							<div class="typeView">
								<p>票种</p>
								<div class="typeList">
									<div class="typeItem active" onclick="typeClick(this, 23)">
										成人票
									</div>
									<div class="typeItem" onclick="typeClick(this, 24)">
										一大一小
									</div>
									<div class="typeItem" onclick="typeClick(this, 25)">
										二大一小
									</div>
								</div>
							</div>
							
							<div class="dateView">
								<p>日期</p>
								<div class="dateList rqList">
									<div class="timeBtn btn1" href="javascript:;" onclick="selectDate(this, 1)"></div>
									<div class="timeBtn btn2" href="javascript:;" onclick="selectDate(this, 2)"></div>
								</div>
							</div>
							
							<div class="dateView">
								<p>班次</p>
								<div class="dateList">
									<div class="timeBtn" href="javascript:;" onclick="selectTime(this, 1)">10:30（玄武门假山环洲码头）</div>
									<div class="timeBtn" href="javascript:;" onclick="selectTime(this, 2)">14:30（玄武门北码头）</div>
								</div>
							</div>
							
							
							<div class="ywrView">
								<p>游玩人信息</p>
								<div class="ywrInfo">
									<div class="ywrItem">
										<p>姓名：</p>
										<input class="userName" type="text" placeholder="请输入游玩人姓名">
									</div>
									<div class="ywrItem">
										<p>手机号：</p>
										<input class="phone" type="number" placeholder="请输入游玩人手机号">
									</div>
								</div>
							</div>
							
							<div class="numberView">
								<p>数量</p>
								<div class="number">
									<a href="javascript:;" onclick="sub(this)">-</a>
									<div class="number_txt">
										<input class="num" type="number" value="0" onchange="quantityChange(this)" disabled="true"/>
									</div>
									<a href="javascript:;" onclick="add(this)">+</a>
								</div>
							</div>
						</div>
					</div>
					
					<a class="buyBtn" href="javascript:;" onclick="buyClick(this)">立即购票</a>
				</div>
			</div>
			
			<div class="banner">
				<img src="img/snx/snx1.jpg" >
			</div>
			
			<div class="buyInfo">
				<div class="ticketView">
					<p>观鸟线</p>
					<p class="price">¥<font>80-160</font></p>
				</div>
				
				<div class="chooseView">
					<div class="chooseTitle" onclick="showClick()">
						<div class="chooseBtn">请选择规格</div>
					</div>
				</div>
			</div>
			<div class="detailInfo">
				<p style="text-align: center;font-size: 14px;color: #333;line-height: 40px;text-indent: 0;">--图文详情--</p>
				<p style="color: red;font-weight: bold;text-indent: 0;">购买完成后，在我的订单-摆渡船订单-订单详情查看核销码，现场由工组人员核销后即可（无需换票）。</p>
				<div class="hf">
					<p style="text-indent: 0;">发船码头：上午（玄武门假山环洲码头）/下午（玄武门北码头）</p>
					<p style="text-indent: 0;">发船班次：每周六及周日，10:30/14:30</p>
					<p style="text-indent: 0;">咨询电话：025-83613166</p>
					<p style="text-indent: 0;">票价：80元/人，可携带一名1米2以下未成年人。</p>
					<p style="text-indent: 0;">票价：100元/一大一小，一小为1米2以上未成年人。</p>
					<p style="text-indent: 0;">票价：160元/二大一小，一小为1米2以上未成年人。</p>
				</div>
			</div>
			<div class="bottomView">
				<p>总计：<font class="totalPrice">0.00</font>元</p>
				<a class="orderBtn" href="chooseOrder.html">我的订单</a>
				<a href="javascript:;" onclick="showClick()">购票</a>
			</div>
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js?v=1.0.0"></script>
		<script type="text/javascript">
			let timeValue;
			let bcValue;
			let ticketsType = 23;
			let visitDate;
			let kc = 40;
			let kcList = [];
			
			$(function(){
				if(app.getQueryString('openid')){
					app.setCookie('openid', app.getQueryString('openid'));
				}
				
				if(!app.getCookie('openid')){
					window.location.replace('http://hd.smart-ideas.com.cn/xwhWeb/xwhApp/?type=snxTickets&code=23');
				}
				
				$('.num').val(1);
				getTotalPrice(1);
				
				// 获取时间
				getBtnTime();
			})
			
			function showClick(){
				$('.shopView').show();
			}
			
			function closeClick(){
				$('.shopView').hide();
			}
			
			function typeClick(that, type){
				$(that).addClass('active').siblings().removeClass('active');
				$('.timeBtn').removeClass('active');
				timeValue = null;
				bcValue = null;
				visitDate = null;
				ticketsType = type;
				kcList = [];
				kc = 40;
				$('.num').val(1);
				getTotalPrice(1);
				if(type == 23){
					$('.shopPrice .priceTxt').text('￥80');
					$('.hf').show();
					$('.cpyt').hide();
				}else if(type == 24){
					$('.shopPrice .priceTxt').text('￥100');
					$('.hf').show();
					$('.cpyt').hide();
				}else if(type == 25){
					$('.shopPrice .priceTxt').text('￥160');
					$('.hf').hide();
					$('.cpyt').show();
				}
				$('.kcTxt').text('库存：'+kc);
			}
			
			// 选择场次
			function selectTime(that, type){
				$(that).addClass('active').siblings().removeClass('active');
				timeValue = type;
				
				let sessionId;
				if(ticketsType == '23'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 16;
						}else if(timeValue == '2'){
							sessionId = 17;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 18;
						}else if(timeValue == '2'){
							sessionId = 19;
						}
					}
				}else if(ticketsType == '24'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 20;
						}else if(timeValue == '2'){
							sessionId = 21;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 22;
						}else if(timeValue == '2'){
							sessionId = 23;
						}
					}
				}else if(ticketsType == '25'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 24;
						}else if(timeValue == '2'){
							sessionId = 25;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 26;
						}else if(timeValue == '2'){
							sessionId = 27;
						}
					}
				}
				if(sessionId == 16 || sessionId == 20 || sessionId == 24){
					kc = kcList[0];
				}else if(sessionId == 17 || sessionId == 21 || sessionId == 25){
					kc = kcList[1];
				}else if(sessionId == 18 || sessionId == 22 || sessionId == 26){
					kc = kcList[2];
				}else if(sessionId == 19 || sessionId == 23 || sessionId == 27){
					kc = kcList[3];
				}
				
				$('.kcTxt').text('库存：'+kc);
			}
			
			// 选择日期
			function selectDate(that, type){
				$(that).addClass('active').siblings().removeClass('active');
				bcValue = type;
				visitDate = $(that).text();
				getkcInfo(visitDate, ticketsType, kc);
			}
			
			// 获取日期
			function getDateString(time){
				let dateString = new Date(time);
				let yearString = dateString.getFullYear();
				let monthString = dateString.getMonth() + 1;
				monthString = monthString > 9 ? monthString : '0' + monthString;
				let dayString = dateString.getDate();
				dayString = dayString > 9 ? dayString : '0' + dayString;
				return yearString + '-' + monthString + '-' + dayString;
			}
			
			function getBtnTime(){
				var nowWeek = new Date().getDay();
				nowWeek = nowWeek==0?7:nowWeek;
				var nowHour = new Date().getHours();
				var nowMinutes = new Date().getMinutes();
				var btn1 = 6;
				var btn2 = 7;
				var nowDateNum = new Date().getTime();
				var btn1DateNum = (btn1 - nowWeek) * 60 * 60 * 24 * 1000 + nowDateNum;
				var btn2DateNum = (btn2 - nowWeek) * 60 * 60 * 24 * 1000 + nowDateNum;
				var btn1Date = new Date(btn1DateNum);
				var btn2Date = new Date(btn2DateNum);
			
				btn1Time = getDateString(btn1Date);
				btn2Time = getDateString(btn2Date);
				$('.btn1').text(btn1Time);
				$('.btn2').text(btn2Time);
			}
			
			function noSale(){
				layer.alert('不支持购买当前日期，请选择其他日期')
			}
			
			// 获取库存数据
			function getkcInfo(date, type, kcNumber){
				kcList = [];
				layer.load('1');
				app.getAjax('/deviceLoopApp/getTicketSessionStock?ticketId='+type +'&visitDate=' + date, {}, function(res){
					setTimeout(function(){
						layer.closeAll();
					}, 350)
					res.data.forEach(function(value,key){
						let kcItem = value.total - value.sell;
						kcItem = kcItem>0?kcItem:0;
						kcList.push(kcItem);
						let sessionId;
						if(ticketsType == '23'){
							if(bcValue == '1'){
								if(timeValue == '1'){
									sessionId = 16;
								}else if(timeValue == '2'){
									sessionId = 17;
								}
							}else if(bcValue == '2'){
								if(timeValue == '1'){
									sessionId = 18;
								}else if(timeValue == '2'){
									sessionId = 19;
								}
							}
						}else if(ticketsType == '24'){
							if(bcValue == '1'){
								if(timeValue == '1'){
									sessionId = 20;
								}else if(timeValue == '2'){
									sessionId = 21;
								}
							}else if(bcValue == '2'){
								if(timeValue == '1'){
									sessionId = 22;
								}else if(timeValue == '2'){
									sessionId = 23;
								}
							}
						}else if(ticketsType == '25'){
							if(bcValue == '1'){
								if(timeValue == '1'){
									sessionId = 24;
								}else if(timeValue == '2'){
									sessionId = 25;
								}
							}else if(bcValue == '2'){
								if(timeValue == '1'){
									sessionId = 26;
								}else if(timeValue == '2'){
									sessionId = 27;
								}
							}
						}
						if(sessionId == 16 || sessionId == 20 || sessionId == 24){
							kc = kcList[0];
						}else if(sessionId == 17 || sessionId == 21 || sessionId == 25){
							kc = kcList[1];
						}else if(sessionId == 18 || sessionId == 22 || sessionId == 26){
							kc = kcList[2];
						}else if(sessionId == 19 || sessionId == 23 || sessionId == 27){
							kc = kcList[3];
						}
						$('.kcTxt').text('库存：'+kc);
					})
				})
			}
			
			function add(that){
				var ticketsNumber = parseInt($(that).parent().find('input').val());
				if(ticketsNumber > 19){
					layer.alert('单次最多购买20张');
					return;
				}
				ticketsNumber += 1;
				$(that).parent().find('input').val(ticketsNumber);
				getTotalPrice(ticketsNumber);
			}
			
			function sub(that){
				var ticketsNumber = parseInt($(that).parent().find('input').val());
				if(ticketsNumber > 1){
					ticketsNumber -= 1;
					$(that).parent().find('input').val(ticketsNumber);
				}
				getTotalPrice(ticketsNumber);
			}
			
			function getTotalPrice(ticketsNumber){
				var singlePrice;
				if(ticketsType == '23'){
					singlePrice = 80;
				}else if(ticketsType == '24'){
					singlePrice = 100;
				}else if(ticketsType == '25'){
					singlePrice = 160;
				}
				var totalPrice = ticketsNumber * singlePrice;
				$('.totalPrice').text(totalPrice.toFixed(2));
				return totalPrice;
			}
			
			function buyClick(that){
				var ticketsNumber = $('.num').val();
				var price = getTotalPrice(ticketsNumber);
				var openid = app.getCookie('openid');
				var userName = $('.userName').val();
				var phone = $('.phone').val();
				if(phone.length != 11){
					layer.alert('请先输入正确的手机号');
					return;
				}
				if(!userName){
					layer.alert('请先输入联系人姓名');
					return;
				}
				if(kc == 0 || !kc){
					layer.alert('当前库存不足，请选择其他时间预约');
					return;
				}
				if(ticketsNumber == 0){
					layer.alert('请先选择购票数量');
					return;
				}
				if(!timeValue || !bcValue){
					layer.alert('请先选择规格');
					return;
				}
				$(that).attr('onclick', '');
				
				let sessionId;
				if(ticketsType == '23'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 16;
						}else if(timeValue == '2'){
							sessionId = 17;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 18;
						}else if(timeValue == '2'){
							sessionId = 19;
						}
					}
				}else if(ticketsType == '24'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 20;
						}else if(timeValue == '2'){
							sessionId = 21;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 22;
						}else if(timeValue == '2'){
							sessionId = 23;
						}
					}
				}else if(ticketsType == '25'){
					if(bcValue == '1'){
						if(timeValue == '1'){
							sessionId = 24;
						}else if(timeValue == '2'){
							sessionId = 25;
						}
					}else if(bcValue == '2'){
						if(timeValue == '1'){
							sessionId = 26;
						}else if(timeValue == '2'){
							sessionId = 27;
						}
					}
				}
				
				console.log(sessionId);
				
				var params = {
					openId: openid,
					totalNumber: ticketsNumber,
					totalMoney: price,
					type: ticketsType,
					visitDate: visitDate,
					userName: userName,
					phone: phone,
					sessionId: sessionId
				};
				wxPay(params, that);
			}
			
			function wxPay(params, that){
				app.getAjax('deviceLoopApp/getWebPayInfo', params, function(res){
					if(res.code == 'SUCCESS'){
						var orderId = res.data.orderId;
						if(res.data.res){
							var res_o = JSON.parse(res.data.res);
							WeixinJSBridge.invoke(
								'getBrandWCPayRequest', {
							       "appId":res_o.appId,     //公众号名称，由商户传入
							       "timeStamp":res_o.timeStamp,  //时间戳，自1970年以来的秒数
							       "nonceStr":res_o.nonceStr, //随机串
							       "package":res_o.package,
							       "signType":res_o.signType,//微信签名方式：
							       "paySign":res_o.paySign //微信签名
								},
								function(res){
									if(res.err_msg == "get_brand_wcpay_request:ok" ) {
										$(that).attr('onclick', 'buyClick()');
										window.location.replace("boatTicketsDetail.html?orderId=" + orderId);
									}else{
										//取消禁用购买按钮
							      		$(that).attr('onclick', 'buyClick(this)');
									}
								}
							);
						}else{
							$(that).attr('onclick', 'buyClick()');
							window.location.replace("boatTicketsDetail.html?orderId=" + orderId);
						}
					}else{
						layer.alert(res.msg);
						//取消禁用购买按钮
						$(that).attr('onclick', 'buyClick(this)');
					}
				})
			}
		</script>
	</body>
</html>
