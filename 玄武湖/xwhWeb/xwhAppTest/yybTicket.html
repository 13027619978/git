<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/gzhTickets.css?v=1.0.0">
		<style type="text/css">
			.timeBtn.disabled{
				background-color: #F0F0F0;
				color: #666;
			}
			.timeBtn{
				margin: 5px 0;
			}
			.kcTxt{
				font-size: 12px;
				color: #8D8D8D;
			}
		</style>
		<title>水上音乐吧购票</title>
	</head>
	<body>
		<div class="container">
			<!-- 购买界面 -->
			<div class="shopView">
				<div class="shopContent">
					<a class="closeBtn" href="javascript:;" onclick="closeClick()">
						<img src="img/close.png" >
					</a>
					<div class="shopContentView">
						<div class="shopTop">
							<div class="shopImg">
								<img src="img/yyb/yyb1.jpg">
							</div>
							<div class="shopPrice">
								<p class="priceTxt">¥198</p>
								<p class="kcTxt">库存：443</p>
							</div>
						</div>
						
						<div class="ggContent">
							<div class="dateView">
								<p>日期</p>
								<div class="dateList">
									<!-- <div class="timeBtn btn1" href="javascript:;" onclick="selectDate(this, 1)">2022-10-01</div>
									<div class="timeBtn btn2" href="javascript:;" onclick="selectDate(this, 2)">2022-10-02</div>
									<div class="timeBtn btn3" href="javascript:;" onclick="selectDate(this, 3)">2022-10-03</div> -->
									<div class="timeBtn btn3" href="javascript:;" onclick="selectDate(this, 4)">2022-10-21</div>
									<div class="timeBtn btn3" href="javascript:;" onclick="selectDate(this, 5)">2022-10-22</div>
								</div>
							</div>
							
							<div class="dateView">
								<p>场次</p>
								<div class="dateList">
									<div class="timeBtn" href="javascript:;" onclick="selectTime(this, 1)">18:00-19:00</div>
									<!-- <div class="timeBtn" href="javascript:;" onclick="selectTime(this, 2)">19:30-20:30</div> -->
								</div>
							</div>
							
							<div class="ywrView">
								<p>游玩人信息</p>
								<div class="ywrInfo">
									<div class="ywrItem">
										<p>手机号：</p>
										<input class="phone" type="number" placeholder="请输入游玩人手机号">
									</div>
								</div>
							</div>
							
							<div class="numberView">
								<p>数量</p>
								<div class="number">
									<a href="javascript:;" onclick="sub(this)">-</a>
									<div class="number_txt">
										<input class="num" type="number" value="0" onchange="quantityChange(this)" disabled="true"/>
									</div>
									<a href="javascript:;" onclick="add(this)">+</a>
								</div>
							</div>
						</div>
					</div>
					
					<a class="buyBtn" href="javascript:;" onclick="buyClick(this)">立即购票</a>
				</div>
			</div>
			
			<div class="banner">
				<img src="img/yyb/yyb1.jpg" >
			</div>
			
			<div class="buyInfo">
				<div class="ticketView">
					<p>玄武湖水上音乐吧</p>
					<p class="price">¥<font>198</font></p>
				</div>
				
				<div class="chooseView">
					<div class="chooseTitle" onclick="showClick()">
						<div class="chooseBtn">请选择规格</div>
					</div>
				</div>
			</div>
			<div class="detailInfo">
				<p style="text-align: center;font-size: 14px;color: #333;line-height: 40px;text-indent: 0;">--图文详情--</p>
				<p style="color: red;font-weight: bold;">购买完成后，在我的订单-水上音乐吧-订单详情查看核销码，现场由工组人员核销后即可（无需换票）。</p>
				<p>服务简介：小众打卡地，仅接受前50名客户预约，约满为止；需提前两天预约</p>
				<p>登船码头：玄武门进门向南100米“桑泊”号码头</p>
				<p>服务亮点：套餐简介：一场音乐之旅+精美点心+茶水；游船时间60分钟</p>
				<p>适用范围：每周五至周日；退票需提前24小时，下单后不支持改期</p>
				<p>咨询电话：18052021903</p>
				<img src="img/yyb/yyb1.jpg">
				<img src="img/yyb/yyb2.jpg">
				<img src="img/yyb/yyb3.jpg">
				<img src="img/yyb/yyb4.jpg">
			</div>
			<div class="bottomView">
				<p>总计：<font class="totalPrice">0.00</font>元</p>
				<a class="orderBtn" href="chooseOrder.html">我的订单</a>
				<a href="javascript:;" onclick="showClick()">购票</a>
			</div>
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js?v=1.0.0"></script>
		<script type="text/javascript">
			let timeValue;
			let bcValue = 1;
			let ticketsType = 21;
			let visitDate = getDateString(new Date().getTime());
			let kc = 300;
			let kcList = [];
			getkcInfo(visitDate, ticketsType, kc);
			
			function showClick(){
				$('.shopView').show();
			}
			
			function closeClick(){
				$('.shopView').hide();
			}
			
			function selectTime(that, type){
				$(that).addClass('active').siblings().removeClass('active');
				timeValue = type;
				console.log(timeValue);
				kc = kcList[type-1];
				if(!kc){
					if(kc == 0){
						kc = 0;
					}else{
						kc = 150;
					}
				}
				$('.kcTxt').text('库存：'+kc);
			}
			
			function selectDate(that, type){
				$(that).addClass('active').siblings().removeClass('active');
				bcValue = type;
				visitDate = $(that).text();
				getkcInfo(visitDate, ticketsType, kc);
			}
			
			// 获取日期
			function getDateString(time){
				let dateString = new Date(time);
				let yearString = dateString.getFullYear();
				let monthString = dateString.getMonth() + 1;
				monthString = monthString > 9 ? monthString : '0' + monthString;
				let dayString = dateString.getDate();
				dayString = dayString > 9 ? dayString : '0' + dayString;
				return yearString + '-' + monthString + '-' + dayString;
			}
			
			function getBtnTime(){
				var nowWeek = new Date().getDay();
				nowWeek = nowWeek==0?7:nowWeek;
				var nowHour = new Date().getHours();
				var nowMinutes = new Date().getMinutes();
				var btn1 = 5;
				var btn2 = 6;
				var btn3 = 7;
				if(nowHour == 20 && nowMinutes >= 30){
					$('.timeBtn').eq(0).attr('onclick', 'noSale()').addClass('disabled');
				}
				if(nowHour == 22){
					$('.timeBtn').eq(0).attr('onclick', 'noSale()').addClass('disabled');
					$('.timeBtn').eq(1).attr('onclick', 'noSale()').addClass('disabled');
				}
				// if(nowWeek == 5){
				// 	if(nowHour == 21){
				// 		$('.timeBtn').eq(0).attr('onclick', 'noSale()').addClass('disabled');
				// 	}
				// }else if(nowWeek == 6){
				// 	$('.timeBtn').eq(0).attr('onclick', 'noSale()').addClass('disabled');
				// 	if(nowHour == 21){
				// 		$('.timeBtn').eq(1).attr('onclick', 'noSale()').addClass('disabled');
				// 	}
				// }else if(nowWeek == 7){
				// 	$('.timeBtn').eq(0).attr('onclick', 'noSale()').addClass('disabled');
				// 	$('.timeBtn').eq(1).attr('onclick', 'noSale()').addClass('disabled');
				// 	if(nowHour == 21){
				// 		$('.timeBtn').eq(2).attr('onclick', 'noSale()').addClass('disabled');
				// 	}
				// }
			// 	var nowDateNum = new Date().getTime();
			// 	var btn1DateNum = (btn1 - nowWeek) * 60 * 60 * 24 * 1000 + nowDateNum;
			// 	var btn2DateNum = (btn2 - nowWeek) * 60 * 60 * 24 * 1000 + nowDateNum;
			// 	var btn3DateNum = (btn3 - nowWeek) * 60 * 60 * 24 * 1000 + nowDateNum;
			// 	var btn1Date = new Date(btn1DateNum);
			// 	var btn2Date = new Date(btn2DateNum);
			// 	var btn3Date = new Date(btn3DateNum);
			
			// 	btn1Time = getDateString(btn1Date);
			// 	btn2Time = getDateString(btn2Date);
			// 	btn3Time = getDateString(btn3Date);
			// 	$('.btn1').text(btn1Time);
			// 	$('.btn2').text(btn2Time);
			// 	$('.btn3').text(btn3Time);
			}
			
			function noSale(){
				layer.alert('不支持购买当前日期，请选择其他日期')
			}
			
			// 获取库存数据
			function getkcInfo(date, type, kcNumber){
				kcList = [];
				layer.load('1');
				app.getAjax('/deviceLoopApp/getTicketSessionStock?ticketId='+type +'&visitDate=' + date, {}, function(res){
					setTimeout(function(){
						layer.closeAll();
					}, 350)
					res.data.forEach(function(value,key){
						let kcItem = value.total - value.sell;
						kcItem = kcItem>0?kcItem:0;
						if(date == '2022-10-05'){
							kcItem = 0;
						}
						if(date == '2022-10-04'){
							if(key == 0){
								kcItem = kcItem - 20;
								kcItem = kcItem>0?kcItem:0;
							}
						}
						kcList.push(kcItem);
					})
					if(timeValue){
						$('.kcTxt').text('库存：'+kcList[timeValue-1]);
					}
				})
			}
			
			$(function(){
				if(app.getQueryString('openid')){
					app.setCookie('openid', app.getQueryString('openid'));
				}
				$('.num').val(1);
				getTotalPrice(1);
				
				// 获取时间
				getBtnTime();
			})
			
			function add(that){
				var ticketsNumber = parseInt($(that).parent().find('input').val());
				if(ticketsNumber > 19){
					layer.alert('单次最多购买20张');
					return;
				}
				ticketsNumber += 1;
				$(that).parent().find('input').val(ticketsNumber);
				getTotalPrice(ticketsNumber);
			}
			
			function sub(that){
				var ticketsNumber = parseInt($(that).parent().find('input').val());
				if(ticketsNumber > 1){
					ticketsNumber -= 1;
					$(that).parent().find('input').val(ticketsNumber);
				}
				getTotalPrice(ticketsNumber);
			}
			
			function getTotalPrice(ticketsNumber){
				var singlePrice = 198;
				var totalPrice = ticketsNumber * singlePrice;
				$('.totalPrice').text(totalPrice.toFixed(2));
				return totalPrice;
			}
			
			function buyClick(that){
				var ticketsNumber = $('.num').val();
				var price = getTotalPrice(ticketsNumber);
				var openid = app.getCookie('openid');
				var phone = $('.phone').val();
				if(phone.length != 11){
					layer.alert('请先输入正确的手机号');
					return;
				}
				if(kc == 0){
					layer.alert('当前库存不足，请选择其他时间预约');
					return;
				}
				if(ticketsNumber == 0){
					layer.alert('请先选择购票数量');
					return;
				}
				if(!timeValue || !bcValue){
					layer.alert('请先选择规格');
					return;
				}
				$(that).attr('onclick', '');
				
				let sessionId;
				if(timeValue == '1'){
					sessionId = 11;
				}else if(timeValue == '2'){
					sessionId = 12;
				}
				
				var params = {
					openId: openid,
					totalNumber: ticketsNumber,
					totalMoney: price,
					phone: phone,
					type: ticketsType,
					visitDate: visitDate,
					sessionId: sessionId
				};
				wxPay(params, that);
			}
			
			function wxPay(params, that){
				app.getAjax('deviceLoopApp/getWebPayInfo', params, function(res){
					if(res.code == 'SUCCESS'){
						var orderId = res.data.orderId;
						if(res.data.res){
							var res_o = JSON.parse(res.data.res);
							WeixinJSBridge.invoke(
								'getBrandWCPayRequest', {
							       "appId":res_o.appId,     //公众号名称，由商户传入
							       "timeStamp":res_o.timeStamp,  //时间戳，自1970年以来的秒数
							       "nonceStr":res_o.nonceStr, //随机串
							       "package":res_o.package,
							       "signType":res_o.signType,//微信签名方式：
							       "paySign":res_o.paySign //微信签名
								},
								function(res){
									if(res.err_msg == "get_brand_wcpay_request:ok" ) {
										$(that).attr('onclick', 'buyClick()');
										window.location.replace("boatTicketsDetail.html?orderId=" + orderId);
									}else{
										//取消禁用购买按钮
							      		$(that).attr('onclick', 'buyClick(this)');
									}
								}
							);
						}else{
							$(that).attr('onclick', 'buyClick()');
							window.location.replace("boatTicketsDetail.html?orderId=" + orderId);
						}
					}else{
						layer.alert(res.msg);
						//取消禁用购买按钮
						$(that).attr('onclick', 'buyClick(this)');
					}
				})
			}
		</script>
	</body>
</html>
