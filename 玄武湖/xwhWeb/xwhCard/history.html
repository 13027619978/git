<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/index.css?v=1.0.1">
		<style type="text/css">
			.container{
				background-color: #f0f0f0;
				min-height: 100vh;
			}
			.noData{
				font-size: 14px;
				color: #666;
				text-align: center;
				line-height: 50px;
				display: none;
			}
			.historyList{
				background-color: #fff;
			}
			.historyList .historyItem{
				padding: 5px 0;
				border-bottom: 1px solid #f0f0f0;
			}
			.historyList .itemBox{
				display: flex;
				justify-content: flex-start;
				align-items: center;
				position: relative;
			}
			.historyList .itemBox p{
				font-size: 13px;
				color: #007AFF;
				line-height: 25px;
			}
			.historyList .itemBox .boxName{
				flex: 0 0 100px;
				text-align: right;
				color: #333;
			}
			.itemBox .qrcodeBtn{
				position: absolute;
				right: 10px;
				bottom: 0;
				line-height: 25px;
				background-color: #00A2ED;
				color: #fff;
				border-radius: 3px;
				padding: 0 10px;
				width: 75px;
				font-size: 14px;
				text-align: center;
			}
			.itemBox .qrcodeBtn.qrBtnHide{
				display: none;
			}
			.qrcodeView{
				position: fixed;
				top: 0;
				right: 0;
				bottom: 0;
				left: 0;
				background-color: rgba(0, 0, 0, .5);
				display: flex;
				justify-content: center;
				align-items: center;
			}
			.qrcodeImg{
				padding: 5px;
				background-color: #fff;
			}
			.closeBtn{
				position: absolute;
				top: 10px;
				right: 10px;
				display: block;
				width: 24px;
				line-height: 20px;
				text-align: center;
				border-radius: 50%;
				background-color: #fff;
				border: 2px solid #333;
				font-size: 14px;
			}
		</style>
		<title>玄武湖景区一卡通</title>
	</head>
	<body>
		<div class="container">
			<p class="noData">--暂无数据--</p>
			<div class="historyList">
				
			</div>
			<div class="qrcodeView">
				<a class="closeBtn" href="javascript:;" onclick="closeClick()">X</a>
				<div class="qrcodeImg">
					<div class="qrcode"></div>
				</div>
			</div>
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.qrcode.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js?v=1.0.1"></script>
		<script type="text/javascript">
			$('.qrcodeView').hide();
			let historyType = app.getQueryString('type');
			let url;
			if(historyType == '0'){
				url = 'recharge';
			}else if(historyType == '1'){
				url = 'consume';
			}else if(historyType == '2'){
				url = 'turn';
			}else{
				url = 'iccard';
			}
			layer.load('1');
			
			function showQrcode(webOrder){
				$('.qrcode').html('');
				$('.qrcodeView').show();
				webOrder = webOrder.toString();
				webOrder = webOrder.split('/')[1].split('/')[0];
				$('.qrcode').qrcode({
					text: webOrder,
					background: '#fff',
					foreground: '#000',
					width: 180,
					height: 180
				});
			}
			
			function closeClick(){
				$('.qrcodeView').hide();
			}
			$(function(){
				app.getAjax('/prod-api/api/h5/query/order/' + url, {
					openId: app.getCookie('openid'),
					orderBy: 'desc'
				}, function(res){
					console.log(res);
					layer.closeAll();
					let historyList = res.rows;
					if(historyList.length == 0){
						$('.noData').show();
					}else{
						$('.nowData').hide();
						historyList.forEach(function(value, key){
							if(historyType == '0'){
								$('.historyList').append(
									'<div class="historyItem">' + 
										'<div class="itemBox">' +
											'<p class="boxName">充值项目：</p>' +
											'<p>'+ value.itemName +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">充值类型：</p>' +
											'<p>微信在线充值</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">本金充值：</p>' +
											'<p>'+ value.rechargeCash +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">赠送充值：</p>' +
											'<p>'+ value.rechargeGive +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">手机号：</p>' +
											'<p>'+ value.phone +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">充值时间：</p>' +
											'<p>'+ value.createTime +'</p>' +
										'</div>' +
									'</div>'
								)
							}else if(historyType == '1'){
								let webOrder = value.webOrderId;
								webOrder = webOrder?webOrder:'无';
								let qrBtnHide = '';
								if(webOrder == '无'){
									qrBtnHide = 'qrBtnHide';
								}
								if(value.refundInfo){
									let refundTime = value.refundInfo.createTime;
									refundTime = refundTime?refundTime:'暂未退款';
									$('.historyList').append(
										'<div class="historyItem">' +
											'<div class="itemBox">' +
												'<p class="boxName">消费项目：</p>' +
												'<p>'+ value.itemName +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费金额：</p>' +
												'<p>'+ value.itemPrice +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费本金金额：</p>' +
												'<p>'+ value.deductCash +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费赠送金额：</p>' +
												'<p>'+ value.deductGive +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费转卡金额：</p>' +
												'<p>'+ value.deductOld +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">退款金额：</p>' +
												'<p>'+ value.refundInfo.refundTotal +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">订单状态：</p>' +
												'<p>已退款</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费时间：</p>' +
												'<p>'+ value.createTime +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">退款时间：</p>' +
												'<p>'+ refundTime +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">web单号：</p>' +
												'<p>'+ webOrder +'</p>' +
												'<a class="qrcodeBtn '+ qrBtnHide +'" href="javascript:;" onclick="showQrcode(/'+ webOrder +'/)">二维码</p>' +
											'</div>' +
										'</div>'
									)
								}else{
									$('.historyList').append(
										'<div class="historyItem">' +
											'<div class="itemBox">' +
												'<p class="boxName">消费项目：</p>' +
												'<p>'+ value.itemName +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费金额：</p>' +
												'<p>'+ value.itemPrice +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费本金金额：</p>' +
												'<p>'+ value.deductCash +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费赠送金额：</p>' +
												'<p>'+ value.deductGive +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费转卡金额：</p>' +
												'<p>'+ value.deductOld +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">消费时间：</p>' +
												'<p>'+ value.createTime +'</p>' +
											'</div>' +
											'<div class="itemBox">' +
												'<p class="boxName">web单号：</p>' +
												'<p>'+ webOrder +'</p>' +
												'<a class="qrcodeBtn '+ qrBtnHide +'" href="javascript:;" onclick="showQrcode(/'+ webOrder +'/)">二维码</p>' +
											'</div>' +
										'</div>'
									)
								}
							}else if(historyType == '2'){
								var cardNo = value.cardNo?value.cardNo:'无';
								$('.historyList').append(
									'<div class="historyItem">' +
										'<div class="itemBox">' +
											'<p class="boxName">转卡类型：</p>' +
											'<p>实体卡转电子卡</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">实体卡号：</p>' +
											'<p>'+ cardNo +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">电子卡手机号：</p>' +
											'<p>'+ value.phone +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">转卡总金额：</p>' +
											'<p>'+ value.totalAmount +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">转卡时间：</p>' +
											'<p>'+ value.createTime +'</p>' +
										'</div>' +
									'</div>'
								)
							}else if(historyType == '3'){
								let operateType = value.operateType;
								operateType = operateType=='0'?'绑卡':operateType=='1'?'解绑':operateType=='2'?'挂失':'解除挂失';
								$('.historyList').append(
									'<div class="historyItem">' +
										'<div class="itemBox">' +
											'<p class="boxName">IC卡号：</p>' +
											'<p>'+ value.iccard +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">用户手机号：</p>' +
											'<p>'+ value.phone +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">操作内容：</p>' +
											'<p>'+ operateType +'</p>' +
										'</div>' +
										'<div class="itemBox">' +
											'<p class="boxName">操作时间：</p>' +
											'<p>'+ value.createTime +'</p>' +
										'</div>' +
									'</div>'
								)
							}
						})
					}
				})
			})
		</script>
	</body>
</html>
