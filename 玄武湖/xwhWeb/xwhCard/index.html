<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/index.css?v=1.0.8">
		<title>玄武湖景区一卡通</title>
	</head>
	<body>
		<div class="container">
			<div class="loginView">
				<div class="loginBox">
					<div class="loginContent">
						<p class="loginTitle">玄武湖景区一卡通</p>
						<div class="inputView">
							<p>手机号：</p>
							<input class="phone" type="text" placeholder="请输入手机号">
						</div>
						<div class="yzmView">
							<p style="flex: 0 0 100px;text-align: center;">验证码：</p>
							<input class="yzm" type="text" placeholder="验证码">
							<a class="yzmBtn" href="javascript:;" onclick="getYzmClick()">获取验证码</a>
						</div>
						<a class="registBtn" href="javascript:;" onclick="loginClick()">注册一卡通</a>
					</div>
				</div>
			</div>
			
			<div class="cardView">
				<div class="card">
					<div class="cardInfo">
						<div class="infoView">
							<div class="infoContent">
								<p class="cardTitle">玄武湖景区一卡通</p>
								<div class="cardContent">
									<div class="priceView">
										<p class="totalMoney">总余额：<font class="totalBalance">0</font>元</p>
										<div class="lastPrice">
											<p class="lastMoney">本金余额<br><font class="cashBalance">0</font>元</p>
											<span></span>
											<p class="lastMoney">赠送余额<br><font class="giveBalance">0</font>元</p>
											<span></span>
											<p class="lastMoney">转卡余额<br><font class="oldBalance">0</font>元</p>
										</div>
									</div>
									<div class="numberView">
										<p class="cardNumber phoneNumber">手机号：</p>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				
				<div class="btnView">
					<!-- <p>*请先确认一卡通余额信息后再点击在线激活</p> -->
					<!-- <a class="jhBtn" href="javascript:;" onclick="activateClick()">在线激活</a> -->
					<a class="czBtn" href="javascript:;" onclick="rechargeClick()">在线充值</a>
				</div>
				
				<a class="qrcodeLabel" href="javascript:;" onclick="qrcodeClick(0)">
					<p>支付二维码</p>
					<img src="img/qrIcon.png" >
				</a>
				
				<div class="history">
					<p class="historyTitle">交易记录</p>
					<div class="historyList">
						<a href="javascript:;" onclick="historyClick(0)">充值记录</a>
						<a href="javascript:;" onclick="historyClick(1)">消费记录</a>
						<a href="javascript:;" onclick="historyClick(2)">转卡记录</a>
						<a style="display: none;" class="icCard" href="javascript:;" onclick="historyClick(3)">IC卡操作记录</a>
					</div>
				</div>
				<div class="gsView">
					<a style="display: none;" class="gs" href="javascript:;" onclick="lossClick()">IC卡挂失</a>
					<a style="display: none;width: 95px;" class="jcgs" href="javascript:;" onclick="cancelLossClick()">IC卡解除挂失</a>
				</div>
			</div>
		</div>
		
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.qrcode.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js?v=1.0.2"></script>
		<script type="text/javascript">
			var code = sessionStorage.getItem('code');
			$('input').on('blur', function (event) {
			 　　if (!(event.relatedTarget && event.relatedTarget.tagName)) document.body.scrollTop = 0;
			});
			
			$(function(){
				app.wxUserInfo(function(){
					getCardInfo();
				})
			})
			
			function loginClick(){
				layer.load('1');
				var phone = $('.phone').val();
				var yzm = $('.yzm').val();
				if(phone.length != 11){
					layer.alert('请输入正确的手机号');
					return;
				}
				if(!yzm){
					layer.alert('请输入验证码');
					return;
				}
				app.postAjax('/prod-api/api/h5/register/', {
					openId: app.getCookie('openid'),
					phone: phone,
					smsCode: yzm
				}, function(res){
					layer.closeAll();
					if(res.code == '200'){
						getCardInfo();
					}else{
						layer.alert(res.msg);
					}
				})
			}
			
			// 二维码点击事件
			function qrcodeClick(vipStatus){
				if(vipStatus == '1'){
					window.location.href = 'pay.html';
				}else{
					layer.alert('请先点击"在线激活"按钮，激活一卡通');
				}
			}
			
			// 获取验证码
			function getYzmClick(){
				var phone = $('.phone').val();
				$('.yzmBtn').addClass('disabled').attr('onclick', '');
				if(phone.length != 11){
					layer.alert('请输入正确的手机号');
					$('.yzmBtn').removeClass('disabled').attr('onclick', 'getYzmClick()');
				}else{
					app.getAjax('/prod-api/api/h5/register/smscode', {
						phone: phone
					}, function(res){
						if(res.code == '200'){
							let seconds = res.data.expires / 10;
							let ymz = setInterval(function(){
								seconds -= 1;
								$('.yzmBtn').text('重新获取('+seconds+'s)');
								if(seconds == 0){
									$('.yzmBtn').text('获取验证码');
									$('.yzmBtn').removeClass('disabled').attr('onclick', 'getYzmClick()');
									clearInterval(ymz);
								}
							}, 1000)
						}else{
							layer.alert(res.msg);
							$('.yzmBtn').removeClass('disabled').attr('onclick', 'getYzmClick()');
						}
					})
				}
			}
			
			// 获取一卡通信息
			function getCardInfo(){
				layer.load('1');
				app.getAjax('/prod-api/api/h5/query/vipInfo', {
					openId: app.getCookie('openid') 
				}, function(res){
					if(res.code == '500'){
						layer.closeAll();
						$('.loginView').show();
					}else{
						$('.loginView').hide();
						var cashBalance = res.data.cashBalance;
						var giveBalance = res.data.giveBalance;
						var oldBalance = res.data.oldBalance;
						var totalBalance = parseFloat(cashBalance*1 + giveBalance*1 + oldBalance*1).toFixed(2);
						var iccardSn = res.data.iccardSn;
						var phone = res.data.phone;
						app.setCookie('phone', phone);
						$('.cashBalance').text(cashBalance);
						$('.giveBalance').text(giveBalance);
						$('.oldBalance').text(oldBalance);
						$('.totalBalance').text(totalBalance);
						$('.phoneNumber').text('手机号：' + phone);
												
						// 是否激活
						if(res.data.vipStatus == '0'){
							layer.closeAll();
							$('.czBtn').show();
							// $('.jhBtn').hide();
							// $('.btnView p').hide();
							$('.qrcodeLabel').attr('onclick', 'qrcodeClick(1)');
							// 有推荐码
							if(code){
								window.location.href = 'recharge.html';
								return;
							}
							// 是否挂失
							if(res.data.iccard){
								$('.icCard').show();
								if(res.data.iccardStatus == '0'){
									$('.gs').show();
									$('.jcgs').hide();
								}else{
									$('.gs').hide();
									$('.jcgs').show();
								}
							}
						}else{
							$('.czBtn').hide();
							// $('.jhBtn').show();
							// $('.btnView p').show();
							// $('.qrcodeLabel').attr('onclick', 'qrcodeClick(0)');
							app.postAjax('/prod-api/api/h5/register/activate', {
								openId: app.getCookie('openid')
							}, function(res){
								layer.closeAll();
								if(res.code == '200'){
									getCardInfo();
								}else{
									layer.alert(res.msg);
								}
							})
						}
					}
				})
			}
			
			// 激活点击事件
			// function activateClick(){
			// 	layer.confirm('请先确认转卡金额是否正确后再激活', {
			// 		btn: ['确认激活', '取消'],
			// 		yes: function(){
			// 			app.postAjax('/prod-api/api/h5/register/activate', {
			// 				openId: app.getCookie('openid')
			// 			}, function(res){
			// 				if(res.code == '200'){
			// 					getCardInfo();
			// 				}else{
			// 					layer.alert(res.msg);
			// 				}
			// 			})
			// 		}
			// 	})
			// }
			
			// 充值点击事件
			function rechargeClick(){
				window.location.href = 'recharge.html';
			}
			
			// 记录点击事件
			function historyClick(type){
				window.location.href = 'history.html?type=' + type;
			}
			
			// 挂失点击事件
			function lossClick(){
				layer.confirm('挂失后8小时后才能解除挂失', {
					btn: ['确认挂失', '取消'],
					yes: function(){
						app.postAjax('/prod-api/api/h5/iccard/loss', {
							openId: app.getCookie('openid')
						}, function(res){
							if(res.code == '200'){
								getCardInfo();
							}else{
								layer.alert(res.msg);
							}
						})
					}
				})
			}
			
			// 解除挂失
			function cancelLossClick(){
				app.postAjax('/prod-api/api/h5/iccard/loss/cancel', {
					openId: app.getCookie('openid')
				}, function(res){
					if(res.code == '200'){
						getCardInfo();
					}else{
						layer.alert(res.msg);
					}
				})
			}
		</script>
	</body>
</html>
