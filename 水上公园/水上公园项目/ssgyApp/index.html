<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" type="text/css" href="css/reset.css"/>
		<link rel="stylesheet" href="css/index.css" />
		<style type="text/css">
			.layui-layer-dialog{
				max-width: 90%;
			}
			.close-notice{
				text-align: center;
			}
		</style>
		<title>水上公园购票</title>
	</head>
	<body>
		<div class="container">
			<div class="banner">
				<img src="img/banner.png"/>
			</div>
			
			<!-- 用户信息部分 -->
			<div class="userInfo">
				<p class="title">个人信息</p>
				<div class="userInfo_content">
					<div class="content_l">
						<div class="headImg" >
							<img class="avatar_img" src="img/banner.jpg"/>
						</div>
						<!--<p class="userName">用户昵称</p>-->
					</div>
					<a href="myOrder.html">我的订单</a>
				</div>
			</div>
			
			<!-- 购票信息 -->
			<div class="buyInfo">
				<p class="title">购票信息</p>
				
				<div class="ticketInfo">
					<p class="ticket-money">全价票：20元/张</p>
				</div>
				
				<div class="buy_item">
					<p class="item_l">全价票：</p>
					<div class="number">
						<a href="javascript:;" onclick="sub(this)">-</a>
						<div class="number_txt">
							<input class="num" type="number" value="0" onchange="quantityChange(this)" disabled="true"/>
							张
						</div>
						<a href="javascript:;" onclick="add(this)">+</a>
					</div>
				</div>
				<div class="buy_item">
					<p class="item_l">购票人电话：</p>
					<input class="buyerPhone" type="number" />
				</div>
			</div>
			
			<!--购票须知-->
			<div class="notice">
				<div class="notice_item">
					<p class="title">购票时间：</p>
					<p>9:00-21:30</p>
				</div>
				
				<div class="notice_item">
					<p class="title">免票：</p>
					<p>1.身高1.2米以下（不含1.2米）儿童可免费入园参观，须有家长陪同。</p>
					<p>2.残疾人，现役军人，残疾军人持本人有效证件可免费入园参观。</p>
				</div>
				
				<div class="notice_item">
					<p class="title">备注：</p>
					<p>1.游客每人限享受一种优惠政策，以最低折扣计算。</p>
					<p>2.门票不记名，不挂失，一经售出，概不退换。</p>
				</div>
			</div>
			
			<div class="bottomView">
				<div class="bottom_l">
					总计：<p><font class="totalPrice">0.00</font>元</p>
				</div>
				<a href="javascript:;" onclick="payClick(this)">购买</a>
			</div>
		</div>
		<div class="close-notice" style="display: none;">
			系统暂停使用
		</div>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js"></script>
		<script type="text/javascript">
			$(function(){
				$('.num').val('0');
				$('.buyerPhone').val('');
				
				//微信授权
				app.wxUserInfo();	
				var openid = app.getCookie('openid');
				console.log(openid);
				//config
				$.ajax({
					type:"get",
					url: app.root + "wx/getWaChatConfig",
					data: {
						url: window.location.href
					},
					dataType: 'json',
					success: function(res){
						var das = res.rows;
						console.log(res);
						wx.config({
							debug: false,
							appId: das.appid,
							timestamp: das.timestamp,
							nonceStr: das.nonceStr,
							signature: das.signature,
							jsApiList: [
								"chooseWXPay"
							]
						});
					}
				});
			})
			//门票数量改变事件
			function quantityChange(that){
				getTotalPrice();
			}
			
			//获取总价格
			function getTotalPrice(){
				//全价票数量
				var adultQuantity = $('.num').eq(0).val();
				//全价票总价格
				var adulePrice = $('.num').eq(0).val() * 20;
				//总价格
				var totalPrice = parseFloat(adulePrice);
				$('.totalPrice').text(totalPrice.toFixed(2));
			}
			
			//加
			function add(that){
				var num = parseInt($(that).parent().find('.num').val());
				if(num < 9){
					num += 1;
					$(that).parent().find('.num').val(num);
					getTotalPrice();
				}else{
					layer.alert('最多只能购买9张门票')
				}
			}
			
			//减
			function sub(that){
				var num = parseInt($(that).parent().find('.num').val());
				if(num > 0){
					num -= 1;
					$(that).parent().find('.num').val(num);
					getTotalPrice();
				}
			}
			
			//购买事件
			function payClick(that){
				layer.alert("系统已停止售票！");
				return;
				var currYear = new Date().getFullYear();
				var currMonth = new Date().getMonth() + 1;
				var currDay = new Date().getDate();
				var startDate = currYear + '/' + currMonth + '/' + currDay + ' 09:00:00';
				var endDate = currYear + '/' + currMonth + '/' + currDay + ' 21:30:00';
				startDate = new Date(startDate).getTime();
				endDate = new Date(endDate).getTime();
				var currDate = new Date().getTime();
//				if($('.num').eq(0).val() == 0 && $('.num').eq(1).val() == 0){
				if(startDate <= currDate && endDate > currDate){
					if($('.num').eq(0).val() == 0){
						layer.alert('购买数量不能少于0')
					}else{
						//openid
						var openid = app.getCookie('openid');
						//全价票数量
						var adultQuantity = $('.num').eq(0).val();
						//全价票总价格
						var adulePrice = $('.num').eq(0).val() * 20;
						//总价格
						var totalPrice = parseFloat(adulePrice);
						//支付金额
						var orderMoney = totalPrice;
						//手机号
						var buyerPhone = $('.buyerPhone').val();
						if(buyerPhone){
							var myreg=/^[1][3,4,5,7,8][0-9]{9}$/;  
				          	if (!myreg.test(buyerPhone)) {  
				            	alert('请输入正确的手机号！')
				          	} else {
				          		//禁用购买按钮
				          		$(that).attr('onclick', '');
								$(that).addClass('disabled');
								
				            	app.postAjax('ticketsOrderApp/buyTickets', {
						            scenicId: '1a5803bc57214a4eb16151c17d86f410',
						            source: 10,
						            type: 0,
						            number: adultQuantity,
						            totalPrice: adulePrice,
						            total: adultQuantity,
									openId: openid
								}, function(res){
									
									var res_o = JSON.parse(res.data.res);
									var orderId = res.data.ticketsId;
									WeixinJSBridge.invoke(
										'getBrandWCPayRequest', {
									       "appId":res_o.appId,     //公众号名称，由商户传入
									       "timeStamp":res_o.timeStamp,  //时间戳，自1970年以来的秒数
									       "nonceStr":res_o.nonceStr, //随机串
									       "package":res_o.package,
									       "signType":res_o.signType,//微信签名方式：
									       "paySign":res_o.paySign //微信签名
										},
										function(res){
											if(res.err_msg == "get_brand_wcpay_request:ok" ) {
												window.location.href = 'success.html?orderId=' + orderId;
											}else{
												//取消禁用购买按钮
								          		$(that).attr('onclick', 'payClick(this)');
								          		$(that).removeClass('disabled');
											}
										}
									);
	
								})
				          	}  
							
						}else{
							layer.alert('请先输入您的手机号');
						}
						
					}
				}else{
					layer.alert('售票时间：9:00-21:30。');
				}
				
			}
		</script>
	</body>
</html>
