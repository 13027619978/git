<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css" />
		<link rel="stylesheet" href="css/index.css" />
		<title>奥森雪圈租赁</title>
	</head>
	<body>
		<div class="container">
			<p class="maxTitle">雪圈租赁</p>
			<div class="form-view">
				<div class="form-item">
					<p>手机号：</p>
					<input class="phone1" type="number" />
				</div>
				<div class="form-item">
					<p>确认手机号：</p>
					<input class="phone2" type="number" />
				</div>
				<div class="form-item">
					<a class="payBtn" href="javascript:;" onclick="payClick()">缴纳押金</a>
				</div>
			</div>
			<div class="desc-view">
				<p class="title">收费标准</p>
				<p>雪圈押金200元，一小时100元，一小时后按半小时累计。</p>
			</div>
		</div>
		
		<script src="js/jquery.min.js"></script>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js"></script>
		<script type="text/javascript">
			$(function(){
				app.payUserInfo();
				//config
				$.ajax({
					type:"get",
					url: app.root + "wx/getWaChatConfig",
					data: {
						url: window.location.href
					},
					dataType: 'json',
					success: function(res){
						var das = res.rows;
						console.log(das);
						wx.config({
							debug: false,
							appId: das.appid,
							timestamp: das.timestamp,
							nonceStr: das.nonceStr,
							signature: das.signature,
							jsApiList: [
								"chooseWXPay"
							]
						});
					}
				});
			})
			
			function payClick(){
				$('.payBtn').attr('onclick', 'reClick()');
				var phone1 = $('.phone1').val();
				var phone2 = $('.phone2').val();
				var normalDeposit = 200;
				if(phone1 != phone2){
					layer.msg('请输入相同的手机号！');
					$('.payBtn').attr('onclick', 'payClick()');
					return;
				};
				if(phone1.length != 11 || phone2.length != 11){
					layer.msg('请输入正确的手机号！');
					$('.payBtn').attr('onclick', 'payClick()');
					return;
				};
				var openId = app.getCookie('openid');
				app.postAjax('otherOrder/saveOtherOrder', {
					openId: openId,
					type: 1,
					phone: phone1,
					normalDeposit: normalDeposit
				}, function(res){
					if(res.code == 'SUCCESS'){
						var res_o = JSON.parse(res.data.res);
						console.log(res_o);
						WeixinJSBridge.invoke(
							'getBrandWCPayRequest', {
						       "appId":res_o.appId,     //公众号名称，由商户传入
						       "timeStamp":res_o.timeStamp,  //时间戳，自1970年以来的秒数
						       "nonceStr":res_o.nonceStr, //随机串
						       "package":res_o.package,
						       "signType":res_o.signType,//微信签名方式：
						       "paySign":res_o.paySign //微信签名
							},
							function(res){
								$('.payBtn').attr('onclick', 'payClick()');
								if(res.err_msg == "get_brand_wcpay_request:ok" ) {
									var nowDate = new Date();
									var nowYear = nowDate.getFullYear();
									var nowMonth = nowDate.getMonth() + 1;
									nowMonth = nowMonth>9?nowMonth:'0'+nowMonth;
									var nowDay = nowDate.getDate();
									nowDay = nowDay>9?nowDay:'0'+nowDay;
									var nowHour = nowDate.getHours();
									nowHour = nowHour>9?nowHour:'0'+nowHour;
									var nowMinutes = nowDate.getMinutes();
									nowMinutes = nowMinutes>9?nowMinutes:'0'+nowMinutes;
									var nowSeconds = nowDate.getSeconds();
									nowSeconds = nowSeconds>9?nowSeconds:'0'+nowSeconds;
									var dateString = nowYear+'-'+nowMonth+'-'+nowDay+' '+nowHour+':'+nowMinutes+':'+nowSeconds;
									window.location.href = 'pay_success.html?date=' + dateString + '&deposit=' + normalDeposit;
								}
							}
						)
					}else{
						layer.msg(res.msg);
						$('.payBtn').attr('onclick', 'payClick()');
					}
				
				})
			}
			
			function reClick(){
				layer.msg('请求中，请勿重复点击！');
			}
		</script>
	</body>
</html>
