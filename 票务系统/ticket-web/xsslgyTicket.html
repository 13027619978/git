<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="./css/cropper.min.css">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/slgy/ticket.css?v=1.0.0">
		<title>提交订单</title>
	</head>
	<body>
		<div class="container">
			<!-- 门票名称 -->
			<div class="ticketName">
				<p class="ticketNameTxt"><font class="ticketType"></font></p>
				<p class="ticketDesc"></p>
			</div>
			
			<!-- 购票须知 -->
			<div class="noticeView">
				<p class="noticeTitle fhlTitle">无名英雄纪念广场活动须知</p>

				<div style="font-size: 13px;color: #333;;line-height: 20px;">
					<p>一、服务活动</p>
					<p>1、活动一：免费提供党旗，入党誓词。活动时间10-15分钟。</p>
					<p>2、活动二：免费提供党旗，入党誓词。专人协助定制花篮的摆放及依次向英烈敬献单支菊花，协助现场拍照。活动时间20-25分钟。</p>
					<p>3、活动三：免费提供党旗，入党誓词。专人协助定制花篮的摆放及依次向英烈敬献单支菊花，协助现场拍照。预约全程讲解服务。活动时间30-45分钟。</p>
					<p>二、收费标准</p>
					<p>1、菊花10元/枝</p>
					<p>2、定制花篮600元/个 高度约1.6米。上联：无名英雄永垂不朽 下联：缅怀英烈牢记使命****单位</p>
					<p>3、讲解500元/次（由无名英雄纪念广场第一层逐层介绍建筑理念、建筑意义及主要英烈英雄事迹等。讲解时长约20分钟）</p>
					<p>三、游客须知</p>
					<p>1、请游客自觉保持无名英雄纪念广场环境卫生。</p>
					<p>2、请勿在无名英雄纪念广场雕塑做攀爬、搂抱、倚靠等不文明行为。</p>
					<p>3、禁止进入草坪区域内。</p>
					<p>4、禁止大声喧哗或说不正当言论。</p>
					<p>5、请游客自觉遵守秩序。</p>
				</div>
			</div>
			
			<!-- 预定时间 -->
			<div class="ticketTime">
				<p class="timeTitle">预定时间</p>
				<div class="timeView">
					<input class="timeInput" type="text" readonly="readonly">
					<p class="ticketPrice"></p>
					<a class="timeSelectBtn" href="javascript:;"></a>
				</div>
			</div>
			
			<!-- 证件类型 -->
			<div class="ticketTime cetTypeView">
				<p class="timeTitle">证件类型</p>
				<div class="cetTypeSelect">
					<label for="cetType1"><input class="cetType" type="radio" id="cetType1" name="cetType" value="0" onchange="certTypeChange(this)" checked="checked">身份证</label>
					<label for="cetType2"><input class="cetType" type="radio" id="cetType2" name="cetType" value="1" onchange="certTypeChange(this)">护照</label>
				</div>
			</div>
			
			<!-- 购票数量 -->
			<div class="ticketNumber">
				<p class="numberText">购票数量：</p>
				<div class="numberView">
					<a class="subBtn" href="javascript:;" onclick="subClick(this)">-</a>
					<input class="numberInput" type="number" readonly="readonly" value="1">
					<a class="addBtn" href="javascript:;" onclick="addClick(this)">+</a>
				</div>
			</div>
			
			<!-- 游客信息 -->
			<div class="visitorInfo">
				<p class="visitorTitle">团体信息</p>
				<div class="visitorList">
					
				</div>
			</div>
			
			<!-- 疫情防控 -->
			<!-- <div class="yqView">
				<div class="radioItem">
					<div>14天内是否有中高风险地区旅行史</div>
					<div class="radioView">
						<label for="lxs1"><input type="radio" id="lxs1" name="lxs" value="0">是</label>
						<label for="lxs2"><input type="radio" id="lxs2" name="lxs" value="1">否</label>
					</div>
				</div>
				<div class="radioItem">
					<div>14天内是否与新冠检测阳性人员密切接触</div>
					<div class="radioView">
						<label for="jcs1"><input type="radio" id="jcs1" name="jcs" value="0">是</label>
						<label for="jcs2"><input type="radio" id="jcs2" name="jcs" value="1">否</label>
					</div>
				</div>
				<div class="radioItem sfyx" style="display: none;">
					<div>48小时内核酸检测结果是否阳性</div>
					<div class="radioView">
						<label for="sfyx1"><input type="radio" id="sfyx1" name="sfyx" value="0">是</label>
						<label for="sfyx2"><input type="radio" id="sfyx2" name="sfyx" value="1">否</label>
					</div>
				</div>
			</div> -->
			
			<!-- 价格合计 -->
			<div class="priceView">
				<div class="priceLeft">
					订单金额：<p class="priceText">0元</p>
				</div>
				<a class="payBtn" href="javascript:;" onclick="payClick(0)">在线支付</a>
			</div>
		</div>
		
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/md5.js?v=1.0.0"></script>
		<script src="js/encrypt.js?v=1.0.2"></script>
		<script src="js/laydate.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/cropper.min.js"></script>
		<script src="js/app4.js?v=1.0.1"></script>
		<script src="js/region.js"></script>
		<script src="js/holiday.js"></script>
		<script type="text/javascript">
			// 游客信息
			var visitorInfo;
			// 性别限制
			var sexType;
			// 年龄限制
			var ageRequired;
			// 最小年龄
			var ageMin;
			// 最大年龄
			var ageMax;
			// 地区限制
			var regionRequired;
			// 限制地区参照
			var regionValue;
			// 可够最远周期
			var buyCycleType;
			// 可够最近天数
			var buyCycleDays;
			// 有效开始日期
			var effectStartDate;
			// 有效结束日期
			var effectEndDate;
			// 购买张数限制
			var buyNumberType;
			// 购买张数
			var buyNumber;
			// 票价
			var settlePrice;
			// 产品ID
			var ticketInfoId;
			// 身份证限制
			var idCardRequired;
			// 头像路径
			var headPicUrl;
			// 票种
			var ticketType;
			// 是否限制最大购票
			var idCardNumberType;
			// 最大购票数
			var idCardNumber;
			// 门票名称
			var ticketBuyName;
			// 当日购票开始时间
			var orderStartTime;
			// 当日购票结束时间
			var orderEndTime;
			
			$(function(){
				// 初始化购票张数
				$('.numberInput').val(1);
				app.clearCookie('ybyNp60');
				app.clearCookie('ybyNp120');
				layer.load(2);
				var enterpriseCode = app.getCookie('enterpriseCode');
				var ticketGroupNum = app.getCookie('ticketGroupNum');
				ticketInfoId = app.getQueryString('ticketInfoId').split('/')[1];
				getSaleInfo(enterpriseCode, ticketGroupNum, ticketInfoId);
				$('.timeInput').val(app.getCookie('visitDate'));
			})
			
			// 证件类型切换
			function certTypeChange(that){
				console.log($(that).val())
				var certType = $(that).val();
				if(certType == '0'){
					$('.idCardTxt').text('身份证：');
					$('.idCard').attr('placeholder', '请输入身份证');
				}else{
					$('.idCardTxt').text('护照：');
					$('.idCard').attr('placeholder', '请输入护照');
				}
			}
			
			// 获取web产品售卖详情
			function getSaleInfo(enterpriseCode, ticketGroupNum, ticketInfoId){
				app.encryptGetAjax('ticketInfo/encrypt/getSalesList', {
					enterpriseCode: enterpriseCode,
					ticketGroupNum: ticketGroupNum,
					ticketSalesChannelsNum: 'WEB'
				}, function(res){
					if(res.code == '10000'){
						layer.closeAll();
						var scenicData = res.data;
						$('.scenicName').text(scenicData.groupName);
						$('.scenicDesc').text(scenicData.mark);
						var saleInfoList = scenicData.ticketSalesInfoList;
						var saleInfo;
						saleInfoList.forEach(function(value, key){
							if(value.ticketInfoId == ticketInfoId){
								console.log(value);
								ticketBuyName = value.ticketName;
								orderStartTime = value.buyRules.orderStartTime;
								orderEndTime = value.buyRules.orderEndTime;
								$('.ticketNameTxt').html(value.ticketName);
								$('.ticketDesc').html(value.description);
								$('.checkTime').text('检票时间：'+value.checkRules.checkStartTime+'-'+value.checkRules.checkEndTime);
								$('.ticketPrice').text(value.ticketName.split('（')[1].split('）')[0].split(')')[0]);
								$('.priceText').text(value.settlePrice + '元');
								if(parseFloat(value.settlePrice) == 0){
									$('.payBtn').text('在线预约');
								}
								ticketType = value.categoryName;
								// 判断身份证必填
								visitorInfo = '<div class="visitorItem">' +
									'<div class="itemInfo">' +
										'<p>单位名称：</p>' +
										'<input class="dwName" type="text" placeholder="请输入单位名称">' +
									'</div>' +
									'<div class="itemInfo">' +
										'<p>联系人姓名：</p>' +
										'<input class="name" type="text" placeholder="请输入联系人姓名">' +
									'</div>' +
									'<div class="itemInfo">' +
										'<p>联系人手机号：</p>' +
										'<input class="phone" type="number" placeholder="请输入联系人手机号">' +
									'</div>'+
									'<div class="itemInfo">' +
										'<p>预计人数：</p>' +
										'<input class="peopleNumber" type="number" placeholder="请输入预计人数">' +
									'</div>' +
									'<div class="itemInfo fjItem">' +
										'<p>附加服务：</p>' +
										'<div class="fjList">' +
											'<div class="fjbox" onclick="fjClick(this)">门票10元/人</div>' +
											'<div class="fjbox" onclick="fjClick(this)">鲜花10元/枝</div>' +
											'<div class="fjbox" onclick="fjClick(this)">花篮600元/个</div>' +
											'<div class="fjbox" onclick="fjClick(this)">讲解500元/次</div>' +
											'<div style="width: 100%;" class="fjbox" onclick="fjClick(this)">书籍:寻找父亲38元/本</div>' +
											'<div style="width: 100%;" class="fjbox" onclick="fjClick(this)">书籍:吴石传45元/本</div>' +
										'</div>' +
									'</div>' +
									'<div class="itemInfo flower">' +
										'<p>鲜花数量：</p>' +
										'<input class="flowerNumber" type="number" placeholder="请输入鲜花数量">' +
									'</div>' +
									'<div class="itemInfo hlsl">' +
										'<p>花篮挽联上联：</p>' +
										'<input class="hlslVal" type="text" placeholder="无名英雄永垂不朽(默认)">' +
									'</div>' +
									'<div class="itemInfo hlxl">' +
										'<p>花篮挽联下联：</p>' +
										'<input class="hlxlVal" type="text" placeholder="xxxxxxxxx敬献">' +
									'</div>' +
									'<div class="itemInfo sj1">' +
										'<p>《寻找父亲》：</p>' +
										'<input class="sj1Number" type="number" placeholder="请输入书籍数量">' +
									'</div>' +
									'<div class="itemInfo sj2">' +
										'<p>《吴石传》：</p>' +
										'<input class="sj2Number" type="number" placeholder="请输入书籍数量">' +
									'</div>' +
								'</div>';
								
								// 票价
								settlePrice = value.settlePrice;
								
								// 身份证限制
								idCardRequired = value.buyRules.idCardRequired;
								
								// 购买张数限制
								buyNumberType = value.buyRules.buyNumberType;
								buyNumber = value.buyRules.buyNumber;
								if(buyNumberType == '1'){
									$('.numberInput').val(buyNumber);
									for(var i = 0; i < buyNumber; i++){
										addVisitor(visitorInfo);
									}
									$('.subBtn').hide();
									$('.priceText').text(settlePrice * buyNumber + '元');
								}else{
									if(ticketInfoId != '2c9141f478ea5c3a01791b5b0ac022a6'){
										addVisitor(visitorInfo);
									}
									$('.priceText').text(settlePrice + '元');
								}
								
								$('.flower').hide();
								$('.hlsl').hide();
								$('.hlxl').hide();
								$('.sj1').hide();
								$('.sj2').hide();
								
								// 最大购票数
								idCardNumberType = value.buyRules.idCardNumberType;
								idCardNumber = value.buyRules.idCardNumber;
								if(idCardNumberType == '1'){
									var noticeIndex = $('.noticeText p').length + 1;
									$('.noticeText').append('<p>'+noticeIndex+'.单次最多购买'+idCardNumber+'张门票</p>');
									if($('.numberInput').val() == idCardNumber){
										$('.addBtn').hide();
									}
								}
								
								if(enterpriseCode == 'TgsEpcYby'){
									$('.noticeText').append('<p>2.请按预约时间段入园游览</p>');	
								}
								
								// 最大购票数是否为1
								if(idCardNumberType == '1'){
									if(idCardNumber == '1'){
										$('.subBtn').hide();
										$('.addBtn').hide();
									}
								}
								
								// 年龄限制
								ageRequired = value.buyRules.ageRequired;
								ageMax = value.buyRules.ageMax;
								ageMin = value.buyRules.ageMin;
								if(ageRequired == '1'){
									var noticeIndex = $('.noticeText p').length + 1;
									$('.noticeText').append('<p>'+noticeIndex+'.购票年龄限制：'+ageMin+'至'+ageMax+'周岁</p>');
								}
								
								// 购买地区限制
								regionRequired = value.buyRules.regionRequired;
								regionValue = value.buyRules.regionValue;
								var regionString = '';
								if(regionRequired == '1'){
									var noticeIndex = $('.noticeText p').length + 1;
									var regionValueList = regionValue.split(',');
									regionValueList.forEach(function(value, key){
										regionList.forEach(function(region, regionKey){
											if(value == region.key){
												regionString += region.value + '、';
											}
										})
									})
									regionString = regionString.substr(0, regionString.length - 1);
									$('.noticeText').append('<p>'+noticeIndex+'.暂不支持'+ regionString +'地区购票</p>');
								}
								
								// 性别限制
								sexType = value.buyRules.sexType;
								if(sexType == '1' || sexType == '2'){
									var noticeIndex = $('.noticeText p').length + 1;
									if(sexType == '1'){
										$('.noticeText').append('<p>'+noticeIndex+'.仅限男性购票</p>');
									}else{
										$('.noticeText').append('<p>'+noticeIndex+'.仅限女性购票</p>');
									}
								}
							}
						})
					}else{
						layer.msg(res.msg);
					}
				})
			}
			var fjNameList = "";
			
			// 附加服务点击事件
			function fjClick(that){
				fjNameList = "";
				if($(that).hasClass('active')){
					$(that).removeClass('active');
					if($(that).text() == '鲜花10元/枝'){
						$('.flower').hide();
					}
					if($(that).text() == '花篮600元/个'){
						$('.hlsl').hide();
						$('.hlxl').hide();
					}
					if($(that).text() == '书籍:寻找父亲38元/本'){
						$('.sj1').hide();
					}
					if($(that).text() == '书籍:吴石传45元/本'){
						$('.sj2').hide();
					}
				}else{
					$(that).addClass('active');
					if($(that).text() == '鲜花10元/枝'){
						$('.flower').show();
					}
					if($(that).text() == '花篮600元/个'){
						$('.hlsl').show();
						$('.hlxl').show();
					}
					if($(that).text() == '书籍:寻找父亲38元/本'){
						$('.sj1').show();
					}
					if($(that).text() == '书籍:吴石传45元/本'){
						$('.sj2').show();
					}
				}
				for(let i = 0; i < $('.fjbox').length; i++){
					if(fjNameList){
						if($('.fjbox').eq(i).hasClass('active')){
							fjNameList += ',' + $('.fjbox').eq(i).text();
						}
					}else{
						if($('.fjbox').eq(i).hasClass('active')){
							fjNameList += $('.fjbox').eq(i).text();
						}
					}
				}
			}
			
			// 增加点击事件
			function addClick(that){
				var ticketNumber = parseInt($('.numberInput').val());
				ticketNumber += 1;
				$('.subBtn').show();
				if(idCardNumberType == '1'){
					if(ticketNumber == idCardNumber){
						$(that).hide();
					}
				}else{
					if(ticketNumber == 99){
						$(that).hide();
					}
				}
				var totalPrice = (settlePrice * 100) * (ticketNumber * 100) / 10000;
				$('.numberInput').val(ticketNumber);
				$('.priceText').text(totalPrice + '元');
				addVisitor();
			}
			
			// 减少点击事件
			function subClick(that){
				var ticketNumber = parseInt($('.numberInput').val());
				ticketNumber -= 1;
				$('.addBtn').show();
				if(buyNumberType == '1'){
					if(ticketNumber == buyNumber){
						$(that).hide();
					}
				}else{
					if(ticketNumber == 0){
						$(that).hide();
					}
				}
				var totalPrice = (settlePrice * 100) * (ticketNumber * 100) / 10000;
				$('.numberInput').val(ticketNumber);
				$('.priceText').text(totalPrice + '元');
				$('.visitorItem').eq(-1).remove();
			}
			
			// 增加游客信息
			function addVisitor(){
				$('.visitorList').append(visitorInfo);
			}
			
			
			function base64ToFile(dataurl){
				var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
			    bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
				while(n--){
					u8arr[n] = bstr.charCodeAt(n);
				}
				return new File([u8arr], 'a.png', {type:mime});
			}
			
			// 在线支付
			function payClick(payType){
				// if(app.getCookie('enterpriseCode') != 'TgsEpcFhl'){
				// 	// 疫情防控
				// 	var lxs =$('input[name="lxs"]:checked').val();
				// 	var jcs =$('input[name="jcs"]:checked').val();
					
				// 	if(lxs && jcs){
				// 		if(lxs == '0' || jcs == '0'){
				// 			layer.alert('建议您向社区报到并进行相关隔离防护, 谢谢您的配合');
				// 			return;
				// 		}
				// 	}else{
				// 		layer.alert('请确认您是否存在中高风险地区旅行史和新冠检测阳性人员接触史');
				// 		return;
				// 	}
				// }
				
				// 禁用支付按钮
				$('.payBtn').attr('onclick', '');
				
				// 购票张数
				var ticketNumber = parseInt($('.numberInput').val());
				if(ticketNumber == 0){
					layer.alert('请先选择购票张数');
					// 启用支付按钮
					if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
						$('.payBtn').attr('onclick', 'checkSm()');
					}else{
						$('.payBtn').attr('onclick', 'payClick(0)');
					}
					return;
				}
				
				// 信息验证
				for(var i = 0; i < ticketNumber; i++){
					var idCard = $('.idCard').eq(i).val();
					var name = $('.name').eq(i).val();
					var phone = $('.phone').eq(i).val();
					var dwName = $('.dwName').eq(i).val();
					var peopleNumber = $('.peopleNumber').eq(i).val();
			
					if(!name || !phone || !dwName || !peopleNumber){
						layer.alert('请先完善游客信息');
						return;
					}else{
						if(phone.length != 11){
							layer.alert('请输入正确的手机号');
							// 启用支付按钮
							if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
								$('.payBtn').attr('onclick', 'checkSm()');
							}else{
								$('.payBtn').attr('onclick', 'payClick(0)');
							}
							return;
						}
					}
				}
				
				// 年龄限制
				if(ageRequired == '1'){
					for(var i = 0; i < ticketNumber; i++){
						var idCard = $('.idCard').eq(i).val();
						var year = parseInt(idCard.substr(6, 4));
						var nowYear = new Date().getFullYear();
						var age = nowYear - year;
						if(parseInt(ageMin) > age || age > parseInt(ageMax)){
							layer.alert('此门票仅限'+ ageMin +'至'+ ageMax +'周岁购买');
							// 启用支付按钮
							if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
								$('.payBtn').attr('onclick', 'checkSm()');
							}else{
								$('.payBtn').attr('onclick', 'payClick(0)');
							}
							return;
						}
					}
				}
				
				// 地区限制
				if(regionRequired == '1'){
					for(var i = 0; i < ticketNumber; i++){
						var idCard = $('.idCard').eq(i).val();
						var region = idCard.substr(0, 2);
						var regionValueList = regionValue.split(',');
						for(var j = 0; j < regionValueList.length; j++){
							if(regionValueList[j] == region){
								regionList.forEach(function(value, key){
									if(region == value.key){
										layer.alert('暂不支持' + value.value + '地区购票');
									}
								})
								// 启用支付按钮
								if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
									$('.payBtn').attr('onclick', 'checkSm()');
								}else{
									$('.payBtn').attr('onclick', 'payClick(0)');
								}
								return;
							}
						}
					}
				}
				
				// 性别限制
				if(sexType == '1' || sexType == '2'){
					for(var i = 0; i < ticketNumber; i++){
						var idCard = $('.idCard').eq(i).val();
						var sex = parseInt(idCard.substr(14, 3));
						if(sexType == '1'){
							if(sex % 2 == 0){
								// 启用支付按钮
								if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
									$('.payBtn').attr('onclick', 'checkSm()');
								}else{
									$('.payBtn').attr('onclick', 'payClick(0)');
								}
								layer.alert('仅限男性购票');
								return;
							}
						}else{
							if(sex % 2 > 0){
								// 启用支付按钮
								if(app.getCookie('enterpriseCode') == 'TgsEpcFhl' && ticketType == '年票'){
									$('.payBtn').attr('onclick', 'checkSm()');
								}else{
									$('.payBtn').attr('onclick', 'payClick(0)');
								}
								layer.alert('仅限女性购票');
								return;
							}
						}
					}
				}
				
				var visitors = [];
				
				for(var i = 0; i < ticketNumber; i++){
					var visitor= {};
					var peopleNumber = $('.peopleNumber').eq(i).val();
					if(fjNameList.indexOf('鲜花') != -1){
						let flowerNumber = $('.flowerNumber').val();
						if(!flowerNumber){
							layer.alert('请先输入鲜花数量');
							$('.payBtn').attr('onclick', 'payClick(0)');
							return;
						}
						fjNameList = fjNameList.split('鲜花10元/枝')[0] + '鲜花10元/枝：' + flowerNumber + fjNameList.split('鲜花10元/枝')[1];
					}
					if(fjNameList.indexOf('花篮') != -1){
						let hlsl = $('.hlslVal').val();
						let hlxl = $('.hlxlVal').val();
						if(!hlsl){
							hlsl = '无名英雄永垂不朽';
						}
						if(!hlxl){
							layer.alert('请先输入花篮挽联下联：xxxxxxx敬献');
							$('.payBtn').attr('onclick', 'payClick(0)');
							return;
						}
						fjNameList = fjNameList.split('花篮600元/个')[0] + '花篮600元/个：' + hlsl + ',' + hlxl + fjNameList.split('花篮600元/个')[1];
					}
					if(fjNameList.indexOf('寻找父亲') != -1){
						let sj1Number = $('.sj1Number').val();
						if(!sj1Number){
							layer.alert('请先输入书籍数量');
							$('.payBtn').attr('onclick', 'payClick(0)');
							return;
						}
						fjNameList = fjNameList.split('书籍:寻找父亲38元/本')[0] + '书籍:寻找父亲38元/本：' + sj1Number + fjNameList.split('书籍:寻找父亲38元/本')[1];
					}
					if(fjNameList.indexOf('吴石传') != -1){
						let sj2Number = $('.sj2Number').val();
						if(!sj2Number){
							layer.alert('请先输入书籍数量');
							$('.payBtn').attr('onclick', 'payClick(0)');
							return;
						}
						fjNameList = fjNameList.split('书籍:吴石传45元/本')[0] + '书籍:吴石传45元/本：' + sj2Number + fjNameList.split('书籍:吴石传45元/本')[1];
					}
					var remark = '预计人数：' + peopleNumber + ',附加服务：' + fjNameList;
					visitor = {
						userName: $('.name').eq(i).val(),
						phone: $('.phone').eq(i).val(),
						companyName: $('.dwName').eq(i).val(),
						remark: remark
					}
					visitors.push(visitor);
				}
				
				var healthCode = 0;
				visitors.forEach(function(value, key){
					// 开启健康宝是删除
					healthCode += 1;
				})
				
				var myInter = setInterval(function(){
					if(healthCode == visitors.length){
						clearInterval(myInter);
						var params;
						params = {
							source: 'WEB',
							payWay: 'WXPAY',
							ticketInfoId: ticketInfoId,
							openId: app.getCookie('openid'),
							totalPrice: parseFloat(settlePrice) * ticketNumber,
							unitPrice: settlePrice,
							visitDate: app.getCookie('visitDate'),
							buyQuantity: ticketNumber,
							visitors: visitors
						}
						// console.log(params);
						// return;
						layer.load(2);
						app.encryptPostAjax('order/encrypt/create', params, function(res){
							console.log(res);
							var orderInfo = res.data;
							if(res.success){
								var name = $('.name').val();
								var phone = $('.phone').val();
								var dwName = $('.dwName').val();
								var peopleNumber = $('.peopleNumber').val();
								var ticketTime = ticketBuyName.split('（')[1].split('）')[0];
								var visitDate = app.getCookie('visitDate') + ' ' + ticketTime;
								$.ajax({
								    url:'http://node.smart-ideas.com.cn:3000/xsslgy/sendMsg',
								    type:"GET",
								    data:{
										name: name,
										phone: phone,
										dwName: dwName,
										peopleNumber: peopleNumber,
										fjName: fjNameList,
										visitDate: visitDate
									},
								    success:function(data){
								    	console.log(data);
								    }
								});
								setTimeout(function(){
									layer.closeAll();
									window.location.href = 'orderDetail.html?ticketId=/' + orderInfo.ticketOrderId + '/';
								}, 500);
								$('.payBtn').attr('onclick', 'payClick(0)');
							}else{
								layer.closeAll();
								// 启用支付按钮
								$('.payBtn').attr('onclick', 'payClick(0)');
								layer.alert(res.message);
							}
						})
					}
				}, 100);
			}
		</script>
	</body>
</html>
