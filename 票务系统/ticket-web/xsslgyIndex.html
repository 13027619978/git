<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/index.css?v=200">
		<style type="text/css">
			.layui-layer-btn .layui-layer-btn0.disabled{
				background-color: #ddd;
				color: #666;
				border: 1px solid #ddd;
			}
			
			.ticketTimeView{
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0,0,0,.5);
				display: flex;
				justify-content: center;
				align-items: center;
				display: none;
			}
			.ticketTimeContent{
				width: 90%;
				background-color: #fff;
				border-radius: 5px;
			}
			.ticketTimeContent>div{
				padding: 5px 20px;
			}
			.ticketTimeTitle{
				font-size: 14px;
				font-weight: bold;
				text-align: center;
				line-height: 45px;
				color: #333;
				border-bottom: 1px solid #ddd;
			}
			.ticketTimeList{
				padding: 0;
				height: 257px;
			}
			.ticketTimeItem{
				width: 100%;
				line-height: 35px;
				border: 1px solid #D0D0D0;
				color: #333;
				font-size: 13px;
				border-radius: 3px;
				margin: 5px 0;
				padding: 0 10px;
				background-color: #fff;
				display: flex;
				justify-content: space-between;
				align-items: center;
			}
			.ticketTimeItem.active{
				background-color: #00B3FD;
				color: #fff;
				border-color: #00B3FD;
			}
			.ticketTimeItem.disabled{
				background-color: #dcdcdc;
				color: #acacab;
			}
			.ticketTimeContent .btnView{
				display: flex;
				justify-content: flex-start;
				align-items: center;
				border-top: 1px solid #ddd;
				padding: 0;
			}
			.btnView a{
				display: block;
				width: 50%;
				text-align: center;
				line-height: 40px;
			}
			.chooseTitle{
				font-size: 14px;
				color: #333;
				font-weight: bold;
				line-height: 25px;
			}
			.ticketTimeContent input{
				width: 120px;
				height: 35px;
				border: 1px solid #ddd;
				border-radius: 3px;
				text-align: center;
				margin-top: 5px;
				font-size: 14px;
				color: #333;
			}
		</style>
		<title>无名英雄纪念广场团体预约</title>
	</head>
	<body>
		<div class="container">
			<!-- 景区名称 -->
			<div class="scenicInfo">
				<p class="scenicName"></p>
				<div class="scenicDesc maxHeight">
					<div class="descContent">
						
					</div>
					<a class="allBtn" href="javascript:;" onclick="showAll(this)">展开全部</a>
				</div>
			</div>
			
			<!-- 通知 -->
			<div class="noticeView">
				<p class="noticeText"><font class="ticketStatus">开园</font>正常开放</p>
			</div>
			
			<!-- 时间段选择 -->
			<div class="ticketTimeView">
				<div class="ticketTimeContent">
					<p class="ticketTimeTitle">请选择预约时间段</p>
					<div>
						<p class="chooseTitle">请选择日期</p>
						<input class="timeSelectBtn" type="text" readonly="readonly">
					</div>
					<div>
						<p class="chooseTitle">请选择场次</p>
						<div class="ticketTimeList">
							
						</div>
					</div>
					<div class="btnView">
						<a onclick="cancelClick()" href="javascript:;">取消</a>
						<a onclick="sureClick()" href="javascript:;">确定</a>
					</div>
				</div>
			</div>
			
			<!-- 门票列表 -->
			<div class="ticketView">
				<p class="ticketTile">团队预约</p>
				<div class="ticketList">
					
				</div>
			</div>
		</div>
		
		<div class="moreView">
			<img src="img/more-icon.png" >
			向下滑动查看更多
		</div>
		
		<!-- tabbar -->
		<div class="tabbar">
			<a class="homeBtn active" href="javascript:;">首页</a>
			<a class="userBtn" href="order.html">我的</a>
		</div>
		
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/md5.js?v=1.0.0"></script>
		<script src="js/encrypt.js?v=1.0.2"></script>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/laydate.js"></script>
		<script src="js/app5.js?v=1.0.4"></script>
		<script type="text/javascript">
			let currentDateList = [];
			let dateList = [];
			let currentDate;
			let swId = [];
			let xwId = [];
			let currentId;
			let buyCycleType;
			let buyCycleDays;
			let effectStartDate;
			let effectEndDate;
			let salesEndDate;
			let layMax;
			let currType;
			let timeList = [
				'8:00--8:30',
				'8:30--9:00',
				'9:00--9:30',
				'9:30--10:00',
				'10:00--10:30',
				'10:30--11:00',
				'13:30--14:00',
				'14:00--14:30',
				'14:30--15:00',
				'15:00--15:30',
				'15:30--16:00',
				'16:00--16:30'
			]
			$(function(){
				var enterpriseCode = app.getCookie('enterpriseCode');
				var ticketGroupNum = app.getCookie('ticketGroupNum');
				// 西山森林公园
				let indexUrl = window.location.href;
				if(enterpriseCode == 'TgsEpcXsslgy' && indexUrl.indexOf('xsslgyIndex') == -1){
					window.location.replace('http://boss.smart-ideas.com.cn/ticket-webTest/xsslgyIndex.html?enterpriseCode=TgsEpcXsslgy&ticketGroupNum=TGN20220726105538295')
				}
				app.wxUserInfo(function(){
					layer.load(2);
					getSaleInfoList(enterpriseCode, ticketGroupNum);
				});
			})
			
			
			// 是否需要滑动
			var scroll = false;
			
			function isAgreeChange(){
				console.log()
				if($('.isAgree').prop("checked")){
					$('.layui-layer-btn0').removeClass('disabled');
				}else{
					$('.layui-layer-btn0').addClass('disabled');
				}
			}
			
			function chooseTime(type){
				$('.ticketTimeView').css({
					'display': 'flex'
				});
				
				currType = type;
				// 最远购票日期
				var nowYear = new Date().getFullYear();
				var nowMonth = new Date().getMonth() + 1;
				nowMonth = nowMonth>9?nowMonth:'0'+nowMonth;
				var nowDay = new Date().getDate();
				nowDay = nowDay>9?nowDay:'0'+nowDay;
				var salesEndDateTime = new Date(salesEndDate.split('-')[0] + '/' + salesEndDate.split('-')[1] + '/' + salesEndDate.split('-')[2] + ' 00:00:00').getTime();
				var nowTime = new Date(nowYear + '/' + nowMonth + '/' + nowDay + ' 00:00:00');
				// 距离购票结束日期剩余天数
				var restDay = (salesEndDateTime - nowTime) / (60 * 60 * 24 * 1000);
				// 距离有效期开始时间
				var startSaleTime = (new Date(effectStartDate.replace(/-/, '/').replace(/-/, '/') + ' 00:00:00') - nowTime) / (60 * 60 * 24 * 1000);
				if(startSaleTime < 0){
					startSaleTime = 0;
				}
				if(buyCycleType == 1){
					if(restDay >= buyCycleDays){
						layMax = parseInt(buyCycleDays) - 1;
					}else{
						layMax = parseInt(restDay);
					}
				}else{
					layMax = parseInt(restDay);
				}
				// 初始化时间插件
				laydate.render({
					elem: '.timeSelectBtn' ,//指定元素
					min: startSaleTime,
					max: 13,
					value: new Date(new Date().getTime() + (60 * 60 * 24 * 1000 * startSaleTime)),
					done: function(value, date, endDate){
						getTicketList(value, currType);
					}
				})
				getTicketList($('.timeSelectBtn').val(), type);
			}
			
			function getTicketList(date, type){
				$('.ticketTimeList').html("");
				let swList = '';
				let xwList = '';
				var enterpriseCode = app.getCookie('enterpriseCode');
				var ticketGroupNum = app.getCookie('ticketGroupNum');
				app.getAjax('orderView/getTicketAppoint', {
					enterpriseCode: enterpriseCode,
					ticketGroupNum: ticketGroupNum,
					today: date,
					isCache: 'N'
				}, function(res){
					timeList.forEach(function(value, key){
						let yyTotal;
						res.forEach(function(item, itemKey){
							if(item.ticketName.indexOf(value) != -1){
								yyTotal = item.total;
							}
						})
						if(key < 6){
							if(yyTotal > 0){
								swList += '<div class="ticketTimeItem disabled" onclick="">场次：'+ value +'<p>已预定</p></div>';
							}else{
								swList += '<div class="ticketTimeItem" onclick="ticketTimeSelect(this, /'+ swId[key] +'/)">场次：'+ value +'<p>未预定</p></div>';
							}
						}else{
							console.log(value);
							if(yyTotal > 0){
								xwList += '<div class="ticketTimeItem disabled" onclick="">场次：'+ value +'<p>已预定</p></div>';
							}else{
								xwList += '<div class="ticketTimeItem" onclick="ticketTimeSelect(this, /'+ xwId[key - 6] +'/)">场次：'+ value +'<p>未预定</p></div>';
							}
						}
					})
					
					if(type == 1){
						$('.ticketTimeList').append(swList);
					}else{
						$('.ticketTimeList').append(xwList);
					}
				})
				
			}
			
			function cancelClick(){
				$('.ticketTimeView').hide();
				currentId = '';
			}
			
			function sureClick(){
				if(currentId){
					ticketClick(currentId);
					currentId = '';
					$('.ticketTimeView').hide();
				}else{
					layer.alert('请先选择预约时段');
				}
			}
			
			function ticketTimeSelect(that, ticketInfoId){
				currentId = ticketInfoId;
				$(that).addClass('active').siblings().removeClass('active');
			}
			
			// 获取web产品售卖列表
			function getSaleInfoList(enterpriseCode, ticketGroupNum){
				app.encryptGetAjax('ticketInfo/encrypt/getSalesList', {
					enterpriseCode: enterpriseCode,
					ticketGroupNum: ticketGroupNum,
					ticketSalesChannelsNum: 'WEB'
				}, function(res){
					if(res.code == '10000'){
						layer.closeAll();
			
						if(res.data.popStatus == '0'){
							layer.alert(res.data.popContent);
						}
						var scenicData = res.data;
						$('.scenicName').text(scenicData.groupName);
						$('.scenicDesc .descContent').html(scenicData.mark);
						if(!scenicData.mark){
							$('.scenicDesc').hide();
						}
						var saleInfoList = scenicData.ticketSalesInfoList;
						saleInfoList.forEach(function(value, key){
							if(key == 0){
								// 可买最远时间限制
								buyCycleType = value.buyRules.buyCycleType;
								buyCycleDays = parseInt(value.buyRules.buyCycleDays);
								effectStartDate = value.effectStartDate;
								effectEndDate = value.effectEndDate;
								salesEndDate = value.buyRules.salesEndDate;
							}
							
							if(key < 6){
								swId.push(value.ticketInfoId);
								// swList += '<div class="ticketTimeItem" onclick="ticketTimeSelect(this, /'+ value.ticketInfoId +'/)">'+ value.ticketName +'</div>';
							}else{
								xwId.push(value.ticketInfoId);
								console.log(xwId);
								// xwList += '<div class="ticketTimeItem" onclick="ticketTimeSelect(this, /'+ value.ticketInfoId +'/)">'+ value.ticketName +'</div>';
							}
							if(key == 0){
								var nowDate = new Date().getTime();
								var salesStartDate = value.buyRules.salesStartDate;
								salesStartDate = salesStartDate.replace(/-/, '/').replace(/-/, '/');
								salesStartDate = new Date(salesStartDate + ' 00:00:00').getTime();
								var ticketItem = '<div class="ticketItem">' +
								'<div class="itemLeft">' +
								'<p class="ticketName">无名英雄纪念广场团体上午场预约</p>' +
								'<div class="ticketDesc"></div>';
								ticketItem += '</div>' +
								'<div class="itemRight">';
								// 判断开始售票时间
								if(salesStartDate <= nowDate){
									ticketItem += '<a class="buyBtn" href="javascript:;" onclick="chooseTime(1)">立即预定</a>';
								}else{
									ticketItem += '<a class="buyBtn disabled" href="javascript:;">立即预定</a>';
								}
								ticketItem += '</div></div>';
								$('.ticketList').append(ticketItem);
								$('.ticketDesc').eq(key).html('无名英雄纪念广场团体上午场预约');
							}else if(key == 1){
								var nowDate = new Date().getTime();
								var salesStartDate = value.buyRules.salesStartDate;
								salesStartDate = salesStartDate.replace(/-/, '/').replace(/-/, '/');
								salesStartDate = new Date(salesStartDate + ' 00:00:00').getTime();
								var ticketItem = '<div class="ticketItem">' +
								'<div class="itemLeft">' +
								'<p class="ticketName">无名英雄纪念广场团体下午场预约</p>' +
								'<div class="ticketDesc"></div>';
								ticketItem += '</div>' +
								'<div class="itemRight">';
								// 判断开始售票时间
								if(salesStartDate <= nowDate){
									ticketItem += '<a class="buyBtn" href="javascript:;" onclick="chooseTime(2)">立即预定</a>';
								}else{
									ticketItem += '<a class="buyBtn disabled" href="javascript:;">立即预定</a>';
								}
								ticketItem += '</div></div>';
								$('.ticketList').append(ticketItem);
								$('.ticketDesc').eq(key).html('无名英雄纪念广场团体下午场预约');
							}
						})
			
						if($('.container').height() + 61 > window.screen.height){
							scroll = true;
							$('.moreView').css({
								'display': 'flex'
							})
						}
					}else if(res.code == '40002'){
						layer.closeAll();
						var scenicData = res.data;
						$('.scenicDesc').removeClass('maxHeight').css({'padding-bottom': 0});
						$('.scenicName').text(scenicData.groupName);
						$('.scenicDesc').text(scenicData.tipContent);
						$('.noticeText').html('<font class="ticketStatus">闭园</font>' + res.message);
						var saleInfoList = scenicData.ticketSalesInfoList;
						saleInfoList.forEach(function(value, key){
							var nowDate = new Date().getTime();
							var effectStartDate = value.effectStartDate;
							effectStartDate = effectStartDate.replace(/-/, '/').replace(/-/, '/');
							effectStartDate = new Date(effectStartDate + ' 00:00:00').getTime();
							var ticketItem = '<div class="ticketItem">' +
							'<div class="itemLeft">' +
							'<p class="ticketName">'+ value.ticketName +'<font class="ticketType">'+ value.categoryName +'</font></p>' +
							'<p class="ticketDesc">'+ value.description +'</p>' +
							'<p class="checkTime">检票时间：'+ value.checkRules.checkStartTime +'-'+ value.checkRules.checkEndTime +'</p>' +
							'<p class="effectTime">售票日期：'+ value.effectStartDate +'至'+ value.effectEndDate +'</p>' +
							'</div>' +
							'<div class="itemRight">' +
							'<p class="ticketPrice">'+ value.settlePrice +'元</p>';
							// 判断开始售票时间
							ticketItem += '<a class="buyBtn disabled" href="javascript:;">立即预定</a>';
							ticketItem += '</div></div>';
							$('.ticketList').append(ticketItem);
						})
					}else{
						layer.closeAll();
						layer.msg(res.msg);
					}
				})
			}
			
			// 屏幕滑动
			$(window).scroll(function(){
				if(scroll){
					$('.moreView').css({
						'display': 'none'
					})
				}
			})
			
			// 点击购票
			function ticketClick(ticketInfoId){
				app.setCookie('visitDate', $('.timeSelectBtn').val());
				// 森林公园购票页
				window.location.href = 'xsslgyTicket.html?ticketInfoId=' + ticketInfoId;
			}
			
			// 展开全部
			function showAll(that){
				$('.scenicDesc').toggleClass('maxHeight');
				if($('.scenicDesc').hasClass('maxHeight')){
					$(that).text('展开全部');
				}else{
					$(that).text('收起全部');
				}
				
			}
			
			// 展开全部票种介绍
			function showAllDesc(that){
				$(that).parent().find('.ticketDesc').toggleClass('maxHeight');
				$(that).toggleClass('close');
				if($(that).parent().find('.ticketDesc').hasClass('maxHeight')){
					$(that).html('<p>展开全部</p>');
				}else{
					$(that).html('<p>收起全部</p>');
				}
				
			}
		</script>
	</body>
</html>
