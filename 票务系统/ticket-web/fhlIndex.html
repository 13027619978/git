<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/fhlIndex.css?v=40">
		<style type="text/css">
			.hoverView{
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(0,0,0,.5);
				display: none;
				z-index: 999;
			}
			.hoverContent{
				display: flex;
				justify-content: center;
				align-items: center;
				width: 100%;
				height: 100%;
			}
			.djqView{
				width: 90%;
				position: relative;
			}
			.djqView img{
				width: 100%;
			}
			.djqView .closeBtn{
				position: absolute;
				right: 0;
				top: 0;
				background-color: #fff;
				display: block;
				width: 35px;
				height: 35px;
				border-radius: 50%;
				text-align: center;
				line-height: 25px;
				color: #333;
				border: 4px solid #009688;
			}
			.qyImg{
				position: absolute;
				top: 37.5%;
				left: 27vw;
			}
			.qyImg img{
				width: 35.5vw;
			}
			.qyBtn{
				display: none;
			}
			.qyNotice{
				line-height: 35px;
				font-size: 12px;
				color: #fff;
				text-align: center;
				position: absolute;
				top: 22vh;
				left: 3vw;
				right: 3vw;
				background: #78ac45;
				border: 1px solid #fff;
				border-radius: 5px;
			}
			.hoverTxt{
				position: absolute;
				right: 6%;
				bottom: 30.5%;
				font-size: 16px;
				color: #fff;
				font-weight: bold;
				letter-spacing: 2px;
			}
		</style>
		<title>凤凰岭景区门票</title>
	</head>
	<body>
		<div class="hoverView">
			<div class="hoverContent">
				<div class="djqView">
					<div class="qrcode" style="display: none;">
						
					</div>
					<p class="hoverTxt"></p>
					<img src="img/fhlDjq.png" >
					<p class="qyNotice">可前往“我的->年票详情”中查看年票权益</p>
					<a class="closeBtn" href="javascript:;" onclick="closeClick()">x</a>
					<div class="qyImg">
						<img src="" >
					</div>
				</div>
			</div>
		</div>
		<div class="container">
			<!-- 通知 -->
			<div class="noticeView">
				<p class="noticeText"><font class="ticketStatus">开园</font>正常售票</p>
			</div>
			
			<!-- 景区名称 -->
			<div class="scenicInfo">
				<div class="scenicDesc maxHeight">
					<div class="descContent">
						
					</div>
					<a class="allBtn" href="javascript:;" onclick="showAll(this)">展开全部</a>
				</div>
			</div>
			
			<!-- 门票列表 -->
			<div class="ticketView">
				<div class="ticketList">
					
				</div>
			</div>
		</div>
		
		<div class="moreView">
			<img src="img/more-icon.png" >
			向下滑动查看更多
		</div>
		
		<!-- tabbar -->
		<div class="tabbar">
			<a class="homeBtn active" href="javascript:;">首页</a>
			<a class="userBtn" href="order.html">我的</a>
		</div>
		
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="js/md5.js?v=1.0.0"></script>
		<script src="js/encrypt.js?v=1.0.2"></script>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="js/jquery.qrcode.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app3.js?v=1.0.0"></script>
		<script type="text/javascript">
			$(function(){
				let nowYear = new Date().getFullYear();
				let nowMonth = new Date().getMonth()+1;
				$('.hoverTxt').text(nowYear + '年' + nowMonth + '月');
				var enterpriseCode = app.getCookie('enterpriseCode');
				var ticketGroupNum = app.getCookie('ticketGroupNum');
				app.wxUserInfo(function(){
					layer.load(2);
					getSaleInfoList(enterpriseCode, ticketGroupNum);
					
					app.encryptGetAjax('order/encrypt/getDetailListByOpenId', {
						openId: app.getCookie('openid'),
						enterpriseCode: enterpriseCode,
						ticketGroupNum: ticketGroupNum
					}, function(res){
						res.data.forEach(function(value, key){
							var yearTicketList = [];
							if(value.categoryName == '年票'){
								yearTicketList.push(value);
							}
							yearTicketList.forEach(function(ticket, ticketKey){
								// 可检票次数
								var checkQuantity = parseInt(ticket.checkQuantity);
								// 剩余检票次数
								var restCheckQuantity = parseInt(ticket.restCheckQuantity);
								if(ticket.payStatus == '1' && restCheckQuantity > 0){
									$('.qrcode').qrcode({
										text: ticket.checkCode + '?time=' + new Date().getTime(),
										background: '#fff',
										foreground: '#000',
										width: 148,
										height: 148
									});
									$('.qrcodeImg img').attr('src', document.getElementsByClassName('qrcode')[0].getElementsByTagName('canvas')[0].toDataURL("image/png"));
									$('.qyImg img').attr('src', document.getElementsByClassName('qrcode')[0].getElementsByTagName('canvas')[0].toDataURL("image/png"));
									app.getAjax('orderEquity/query', {
										qr: ticket.checkCode,
										equityCode: 1
									}, function(res){
										console.log(res);
										if(res.success){
											if(res.data.useState == '0' && !app.getCookie('hoverShow')){
												$('.hoverView').slideDown();
											}
										}
										return;
									})
								}
							})
						})
					})
				});
			})
			
			// 是否需要滑动
			var scroll = false;
			
			// 获取web产品售卖列表
			function getSaleInfoList(enterpriseCode, ticketGroupNum){
				app.encryptGetAjax('ticketInfo/encrypt/getSalesList', {
					enterpriseCode: enterpriseCode,
					ticketGroupNum: ticketGroupNum,
					ticketSalesChannelsNum: 'WEB'
				}, function(res){
					console.log(res);
					if(res.code == '10000'){
						layer.closeAll();
						if(res.data.popStatus == '0'){
							layer.alert(res.data.popContent);
						}
						var scenicData = res.data;
						$('.scenicName').text(scenicData.groupName);
						$('.scenicDesc .descContent').html(scenicData.mark);
						if(!scenicData.mark){
							$('.scenicDesc').hide();
						}
						var saleInfoList = scenicData.ticketSalesInfoList;
						saleInfoList.forEach(function(value, key){
							var nowDate = new Date().getTime();
							var salesStartDate = value.buyRules.salesStartDate;
							salesStartDate = salesStartDate.replace(/-/, '/').replace(/-/, '/');
							salesStartDate = new Date(salesStartDate + ' 00:00:00').getTime();
							// 凤凰岭
							var categoryName = value.categoryName;
							if(app.getCookie('fhlNp')){
								if(categoryName == '年票'){
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<img src="img/np2023Img.jpg" >' +
											'<div class="leftTxt">' +
												'<p class="ticketName"><font class="hot">热</font>'+ value.ticketName +'</p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn">立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></a>';
									$('.ticketList').append(ticketItem);
									$('.ticketDesc').eq(key).html('<p>即买即用，每日限本人使用一次</p><p>年票有效期至2023年12月31日</p><p>购买前请您仔细阅读使用说明</p><p class="icon">如已购买，请在右下角“我的”里面查找您所购买的年票</p>');
								}
							}else{
								if(categoryName == '年票'){
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<img src="img/np2023Img.jpg" >' +
											'<div class="leftTxt">' +
												'<p class="ticketName"><font class="hot">热</font>'+ value.ticketName +'</p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn">立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></a>';
									$('.ticketList').append(ticketItem);
									$('.ticketDesc').eq(key).html('<p>即买即用，每日限本人使用一次</p><p>年票有效期至2023年12月31日</p><p>购买前请您仔细阅读使用说明</p><p class="icon">如已购买，请在右下角“我的”里面查找您所购买的年票</p>');
								}else if(categoryName == '优惠票'){
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<div class="leftTxt">' +
												'<p class="ticketName ts">'+ value.ticketName +'<span class="tsIcon"></span></p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn">立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></div>';
									$('.ticketList').append(ticketItem);
									$('.ticketDesc').eq(key).html('<p>优惠票（须持学生证等相关证件购买）</p><a href="javascript:;" onclick="readClick(/'+ value.ticketInfoId +'/)">具体范围参照公示</a>');
									if(value.ticketInfoId == '2c9141f476a897de0176a8d1a5910051' || value.ticketInfoId == '2c9141f476a897de0176a8cf57d6004a'){
										$('.ticketDesc').eq(key).html('<p>1、1米以上儿童须购买全价票。</p><a href="javascript:;" onclick="readClick(/'+ value.ticketInfoId +'/)">具体范围参照公示</a>');
									}
								}else if(categoryName == '政策性免票'){
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<div class="leftTxt">' +
												'<p class="ticketName ts">'+ value.ticketName +'<span class="tsIcon"></span></p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn">立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></div>';
									$('.ticketList').append(ticketItem);
									$('.ticketDesc').eq(key).html('<p>政策性免票（须持相关证件购买）</p><a href="javascript:;" onclick="readClick(/'+ value.ticketInfoId +'/)">具体范围参照公示</a>');
								}else if(categoryName == '活动票'){
									var ticketName = value.ticketName;
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<div class="leftTxt">' +
												'<p class="ticketName">'+ value.ticketName +'<span class="tsIcon"></span></p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn" >立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></a>';
									$('.ticketList').append(ticketItem);
									if(ticketName.indexOf('全价+') != -1){
										$('.ticketDesc').eq(key).html('<p>多人票|须持相关证件购买优惠票</p>');
									}else{
										$('.ticketDesc').eq(key).html('<p>活动票|须持相关证件购买优惠票</p>');
									}
								}else{
									var buyClick = 'ticketClick(/'+ value.ticketInfoId +'/)';
									if(salesStartDate > nowDate){
										buyClick = '';
									}
									var ticketItem = '<a href="javascript:;" class="ticketItem" onclick="'+ buyClick +'">' +
										'<div class="itemLeft">' + 
											'<div class="leftTxt">' +
												'<p class="ticketName">'+ value.ticketName +'</p>' +
												'<div class="ticketDesc">' +
												'</div>' +
											'</div>' +
										'</div>' +
										'<div class="itemRight">' +
											'<p class="ticketPrice"><font>￥</font>'+ value.settlePrice +'</p>';
									// 判断开始售票时间
									if(salesStartDate <= nowDate){
										ticketItem += '<div class="buyBtn">立即预订</div>';
									}else{
										ticketItem += '<div class="buyBtn disabled">立即预定</div>';
									}		
									ticketItem += '</div></a>';
									$('.ticketList').append(ticketItem);
									$('.ticketDesc').eq(key).html('<p>成人票</p>');
									if(value.ticketInfoId == '2c9141f476a897de0176a8d1a5910051' || value.ticketInfoId == '2c9141f476a897de0176a8cf57d6004a'){
										$('.ticketDesc').eq(key).html('<p>1、1米以上儿童须购买全价票。</p><a href="javascript:;" onclick="readClick(/'+ value.ticketInfoId +'/)">具体范围参照公示</a>');
									}
								}
							}
						})
			
						if($('.container').height() + 61 > window.screen.height){
							scroll = true;
							$('.moreView').css({
								'display': 'flex'
							})
						}
					}else if(res.code == '40002'){
						layer.closeAll();
						var scenicData = res.data;
						$('.scenicDesc').removeClass('maxHeight').css({'padding-bottom': 0});
						$('.scenicName').text(scenicData.groupName);
						$('.scenicDesc').text(scenicData.tipContent);
						var saleInfoList = scenicData.ticketSalesInfoList;
						saleInfoList.forEach(function(value, key){
							var nowDate = new Date().getTime();
							var effectStartDate = value.effectStartDate;
							effectStartDate = effectStartDate.replace(/-/, '/').replace(/-/, '/');
							effectStartDate = new Date(effectStartDate + ' 00:00:00').getTime();
							var ticketItem = '<div class="ticketItem">' +
							'<div class="itemLeft">' +
							'<p class="ticketName">'+ value.ticketName +'<font class="ticketType">'+ value.categoryName +'</font></p>' +
							'<p class="ticketDesc">'+ value.description +'</p>' +
							'<p class="checkTime">检票时间：'+ value.checkRules.checkStartTime +'-'+ value.checkRules.checkEndTime +'</p>' +
							'<p class="effectTime">售票日期：'+ value.effectStartDate +'至'+ value.effectEndDate +'</p>' +
							'</div>' +
							'<div class="itemRight">' +
							'<p class="ticketPrice">'+ value.settlePrice +'元</p>';
							// 判断开始售票时间
							ticketItem += '<a class="buyBtn disabled" href="javascript:;">立即预定</a>';
							ticketItem += '</div></div>';
							$('.ticketList').append(ticketItem);
							$('.noticeText').html('<font class="ticketStatus">闭园</font>' + res.message);
							
						})
					}else{
						layer.closeAll();
						layer.msg(res.msg);
					}
				})
			}
			
			// 优惠票参照公式
			function readClick(bindTicketId){
				window.event? window.event.cancelBubble = true : e.stopPropagation();
				if(bindTicketId == '/2c9141f476a897de0176a8d1a5910051/' || bindTicketId == '/2c9141f476a897de0176a8cf57d6004a/'){
					var noticeString = '<p>1、1米以上儿童须购买全价票。<br>';
					noticeString += '2、购买此门票方可进入冰雪乐园。<br>';
					noticeString += '3、出冰雪乐园后再进园须重新购票。<br>';
					noticeString += '4、入园时间：9：00-16：30。<br>';
					noticeString += '5、请科学佩戴口罩，不扎堆不聚集，保持安全距离。<br>';
					noticeString += '6、老人、孕妇或高血压、心脏病等不宜参加冰雪运动者，谢绝入内。<br>';
					noticeString += '7、请遵守园内安全提示，听从工作人员指挥。<br>';
					noticeString += '8、场地内为冰雪地面，请注意防滑。<p>';
					layer.open({
						content: noticeString,
						btn: ['我已阅读，前往购票'],
						closeBtn: 0,
						title: '购票须知'
					});
				}else{
					var noticeString = '<p>北京凤凰岭景区门票优惠办法：<br>';
					noticeString += '1.6周岁（含6周岁）以下或身高1.2米（含1.2米）以下儿童免票。<br>';
					noticeString += '2.60-65周岁老年人凭老年证门票优惠；65周岁以上凭证免票；持本人北京市养老助残卡免票（节假日和景区举办大型活动期间无效）。<br>';
					noticeString += '3.全日制本科及以下学生凭学生证门票优惠。<br>';
					noticeString += '4.现役军人、武警官兵、消防救援人员、离休人员、残疾人凭相关证件免票；<p>';
					layer.open({
						content: noticeString,
						btn: ['我已阅读，前往购票'],
						closeBtn: 0,
						title: '优惠政策'
					});
				}
				
			}
			
			// 屏幕滑动
			$(window).scroll(function(){
				if(scroll){
					$('.moreView').css({
						'display': 'none'
					})
				}
			})
			
			// 点击购票
			function ticketClick(ticketInfoId){
				var enterpriseCode = app.getCookie('enterpriseCode');
				if(enterpriseCode == 'TgsEpcSch'){
					// 什刹海购票页
					window.location.href = 'schTicket.html?ticketInfoId=' + ticketInfoId;
				}else{
					window.location.href = 'ticket.html?ticketInfoId=' + ticketInfoId;
				}
			}
			
			// 展开全部
			function showAll(that){
				$('.scenicDesc').toggleClass('maxHeight');
				if($('.scenicDesc').hasClass('maxHeight')){
					$(that).text('展开全部');
				}else{
					$(that).text('收起全部');
				}
				
			}
			
			// 权益弹窗关闭
			function closeClick(){
				$('.hoverView').hide();
				app.setCookie('hoverShow', true);
			}
			
			// 展开全部票种介绍
			function showAllDesc(that){
				$(that).parent().find('.ticketDesc').toggleClass('maxHeight');
				$(that).toggleClass('close');
				if($(that).parent().find('.ticketDesc').hasClass('maxHeight')){
					$(that).html('<p>展开全部</p>');
				}else{
					$(that).html('<p>收起全部</p>');
				}
				
			}
			
		</script>
	</body>
</html>
