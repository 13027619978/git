<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/order.css?v=10">
		<title>我的订单</title>
	</head>
	<body>
		<div class="container">
			<p class="noData">--暂无数据--</p>
			<!-- 订单列表 -->
			<div class="orderList">
				
			</div>
		</div>
		
		<!-- tabbar -->
		<!-- <div class="tabbar">
			<a class="homeBtn" href="javascript:;" onclick="homeClick()">首页</a>
			<a class="userBtn active" href="javascript:;">我的</a>
		</div> -->
		
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/app.js?v=10"></script>
		<script>
			var headPicUrl;
			var orderList = [];
			$(function(){
				var openid = app.getCookie('openid');
				
				if(openid){
					$('.homeBtn').attr('href', 'index.html?openid=' + openid);
				}
				app.getAjax('order/getDetailListByOpenId', {
					openId: openid,
					enterpriseCode: app.getCookie('enterpriseCode'),
					ticketGroupNum: app.getCookie('ticketGroupNum')
				}, function(res){
					if(res.success){
						orderList = res.data;
						
						if(orderList.length == 0){
							$('.noData').show();
							$('.orderList').hide();
						}else{
							orderList.forEach(function(value, key){
								// 可检票次数
								var checkQuantity = parseInt(value.checkQuantity);
								// 剩余检票次数
								var restCheckQuantity = parseInt(value.restCheckQuantity);
								var checkStatus;
								var className;
								var ywShow = 'block';
								if(value.payStatus == '1'){
									if(checkQuantity == restCheckQuantity){
										checkStatus = '未核销';
									}else if(restCheckQuantity > 0){
										checkStatus = '部分核销';
									}else{
										checkStatus = '已核销';
									}
									className = 'black';
									ywShow = 'none';
								}else{
									checkStatus = '退票成功';
									className = 'red';
								}
								
								var orderItem = '<div class="orderItem" onclick="orderClick(/'+ value.ticketOrderId +'/)">' +
											'<div class="ticketName">' +
												'<p class="name">'+ value.ticketName + '<font>'+ value.categoryName +'</font></p>' +
												'<p class="status '+className+'">'+ checkStatus +'</p>' +
											'</div>' +
											'<div class="timeView">' +
												'<p class="time">订单编号：'+ value.orderNum +'</p>' +
											'</div>' +
											'<div class="timeView">' +
												'<p class="time">购买张数：'+ value.buyQuantity +'</p>' +
											'</div>' +
											'<div class="timeView">' +
												'<p class="time">支付时间：'+ value.payTime +'</p>' +
												'<p class="price">合计<font>￥'+ value.totalPrice +'</font></p>' +
											'</div>' +
										'</div>';
										
								if(value.ticketName.indexOf('年票') != -1){
									$('.orderList').append(orderItem);
								}
							})
						}
					}else{
						layer.alert(res.message);
						$('.nowData').show();
						$('.orderList').hide();
					}
				})
			})
			
			function orderClick(ticketId){
				orderList.forEach(function(value, key){
					console.log(ticketId.toString().split('/'));
					if(value.ticketOrderId == ticketId.toString().split('/')[1]){
						console.log(value.headPicUrl);
						headPicUrl = value.headPicUrl;
					}
				})
				app.setCookie('headPicUrl', headPicUrl);
				window.location.href = 'fhlNpDetail.html?ticketId=' + ticketId;
			}
		</script>
	</body>
</html>
