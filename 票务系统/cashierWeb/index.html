<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<link rel="stylesheet" href="css/reset.css" />
		<link rel="stylesheet" href="css/pay.css?v=1.0.0" />
		<title>二维码收款</title>
	</head>
	<body>
		<div class="container">
			<div class="collectionView">
				<div class="shopName">
					<img src="img/shop_icon.png"/>
					<p class="payTitle"></p>
				</div>
				<div class="inputView">
					<input type="number" placeholder="金额" id="money"/>
					<p>元</p>
				</div>	
				<a href="javascript:;" class="payBtn" onclick="payClick()">向商家付款</a>
			</div>
		</div>
		
		
		<script src="js/jquery.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="js/app.js?v=1.0.2"></script>
		<script type="text/javascript">
			let cashierItemId;
			let cashierType;
			$(function(){
				//微信授权
				app.payUserInfo(function(){
					app.getAjax('cashierItem/item/' + app.getCookie('code') + '/' + app.getCookie('group_num'), {}, function(res){
						console.log(res);
						$('.payTitle').text(res.data.itemName);
						cashierItemId = res.data.id;
						cashierType = res.data.type;
						if(cashierType == 1){
							$('#money').val(res.data.price).attr('readonly', 'readonly')
						}
					})
				});
			})
			
			
			function payClick(){
				var money = $('#money').val();
				if(money && money > 0){
					// 禁用支付按钮
					$('.payBtn').addClass('disabled');
					$('.payBtn').attr('onclick', '');
					
					app.getAjax('cashier/item/order/pay', {
						ticketGroupId: app.getCookie('group_num'),
						cashierItemId: cashierItemId,
						payWay: 'H5',
						price: money,
						cashierType: cashierType,
						openId: app.getCookie('openid')
					}, function(res){
						
						var res_o = JSON.parse(res.data.payParams);
						console.log(res_o);
						
						WeixinJSBridge.invoke(
							'getBrandWCPayRequest', {
							   "appId":res_o.appId,     //公众号名称，由商户传入
							   "timeStamp":res_o.timeStamp,  //时间戳，自1970年以来的秒数
							   "nonceStr":res_o.nonceStr, //随机串
							   "package":res_o.package,
							   "signType":res_o.signType,//微信签名方式：
							   "paySign":res_o.paySign //微信签名
							},
							function(res){
								console.log(res);
								$('.payBtn').removeClass('disabled');
								$('.payBtn').attr('onclick', 'payClick()');
								if(res.err_msg == "get_brand_wcpay_request:ok" ) {
									var date = new Date();
									var seperator1 = "-";
									var seperator2 = ":";
									var month = date.getMonth() + 1;
									var strDate = date.getDate();
									if (month >= 1 && month <= 9) {
										month = "0" + month;
									}
									if (strDate >= 0 && strDate <= 9) {
										strDate = "0" + strDate;
									}
									var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
											+ " " + date.getHours() + seperator2 + date.getMinutes()
											+ seperator2 + date.getSeconds();
									let itemName = $('.payTitle').text();
									itemName = encodeURI(itemName);
									window.location.href = 'pay_success.html?date=' + currentdate + '&money=' + money + '&itemName=' + itemName;
									return;
								}
						});
					})
				}else{
					layer.alert('请先输入您的支付金额！');
				}
			}
		</script>
	</body>
</html>
