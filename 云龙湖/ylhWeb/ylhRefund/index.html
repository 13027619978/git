<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0" />
		<meta http-equiv="Expires" content="0">
		<meta http-equiv="Pragma" content="no-cache">
		<meta http-equiv="Cache-control" content="no-cache">
		<meta http-equiv="Cache" content="no-cache">
		<link rel="stylesheet" href="css/reset.css" />
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<style type="text/css">
			.jszc{
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				font-size: 12px;
				color: #fff;
				text-align: center;
				line-height: 35px;
				background: rgba(0,0,0,.7);
			}
		</style>
		<title>云龙湖租赁退款</title>
	</head>
	<body>
		<div class="container">
			<div class="content">
				<p class="name"></p>
				<!-- <div class="coupons">
					<input class="userPhone" style="font-size: 14px;color: #333;border: 1px solid #ddd;border-radius: 5px;height: 35px;width: 100%;padding: 0 10px;margin-bottom: 10px;box-sizing: border-box;" type="text" placeholder="请输入含优惠券手机号">
					<p style="font-size: 12px;color: red;">如有优惠券，请退款前提前输入含优惠券的手机号</p>
				</div> -->
				<div class="searchView">
					<p class="notice"></p>
				</div>
				<a class="search-btn" href="javascript:;" onclick="searchClick()">确认退押金</a>
				<div class="notice_txt">
		        	<p>温馨提示：</p>
			        <p>1.请上岸扫描大屏幕退款二维码。</p>
			        <p>2.核对退款信息。</p>
			        <p>3.点击退款，手动退款。</p>
		        </div>
				<p class="jszc">数字化系统服务商: 北京骑思妙享科技有限公司 400-898-7021</p>
			</div>
		</div>
		
		<script src="js/jquery-2.1.4.min.js"></script>
		<script src="layer/layer.js"></script>
		<script src="js/jweixin-1.0.0.js"></script>
		<script src="js/app.js?v=50"></script>
		<script type="text/javascript">
			var refundData;
			var priceData;
			var click = true;
			var host = 'http://rent.smart-ideas.com.cn/';
			
			$(function(){
				//防止页面后退
				history.pushState(null, null, document.URL);
				window.addEventListener('popstate', function () {
					wx.closeWindow();
				});
				
				app.wxUserInfo(function(){
					var scenicId = app.getCookie('scenicId');
					console.log(scenicId);
					var scenicName;
					if(scenicId == '14249a7ee96d4d3f95195a799a3709d2'){
					  scenicName = '杏花坞';
					}else if(scenicId == '2a96be8cf7744d9088986920e2f0d6d9'){
					  scenicName = '开元宾馆';
					}else if(scenicId == '47fca49def99492c80a58d8592400589'){
					  scenicName = '老子水居';
					}else if(scenicId == '4c74b97aaf5b4ff594d11841d4ec8de9'){
					  scenicName = '南湖一号';
					}else if(scenicId == '5acd3b7ae10544ec9632b41392c0e695'){
					  scenicName = '解忧桥';
					}else if(scenicId == '7911474d3e1b42e891bd91f6eaf55077'){
					  scenicName = '未定';
					}else if(scenicId == '8ea1d467f3af4d2aa46b09219d6273f6'){
					  scenicName = '断桥';
					}else if(scenicId == 'b3bb924f74ed4e8ebcad576a382e8791'){
					  scenicName = '沉水廊道';
					}else if(scenicId == 'cdabffaf5cb442da8f5ca9ac50f85efc'){
					  scenicName = '水族馆（沙月岛）';
					}else if(scenicId == 'ed28b43724f0477d9755de59b28160dd'){
					  scenicName = '音乐厅';
					}else if(scenicId == 'f769f573bc3e4df5986ec45993e94fbd'){
					  scenicName = '苏公塔';
					}else if(scenicId == 'e258ca79d5ca4e33b177794a6d815ad5'){
					  scenicName = '测试码头';
					}
					$('.name').text(scenicName);
					
					getRefundInfo(host)
				});
			})
			
			function getRefundInfo(host){
				$.ajax({
					type:"get",
					url:host + "ylhpark/devicePosLeaseApp/getWebRefundInfo?openId=" + app.getCookie('openid') + '&scenicId=' + app.getCookie('scenicId'),
					async:true,
					success: function(data){
						console.log(data);
						layer.closeAll();
						$('.searchView').html("");
						if(data.code == "SUCCESS"){
							var user = data.data.order;
							var order = data.data.order;
							refundData = data.data.order;
							priceData = data.data.scenicPrice;
							var bikeType = "";
							if(order.deviceType == '0'){
								bikeType = "四人船";
							}else if(order.deviceType == '1'){
								bikeType = "六人船";
							}
							var de = order.normalDeposit;
							var ac = order.actualConsumeMoney;
							var re = "";
							if(de*1 <= ac*1){
								ac = de;
								re = 0;
							}else{
								re = (de*1 - ac*1).toFixed(2);
							}
							app.getAjax('couponsOrder/user/getList', {
								phone: user.phone
							}, function(res){
								if(res.code == 'SUCCESS'){
									if(res.data.length > 0){
										var singlePrice = priceData.price;
										var couponsCount = Math.ceil(ac / singlePrice);
										var couponsList = res.data;
										var useCoupons = 0;
										couponsList.forEach(function(value, key){
											var effectEndDate = value.effectEndDate;
											effectEndDate = effectEndDate.replace(/-/, "/").replace(/-/, "/");
											var effectStartDate = value.effectStartDate;
											effectStartDate = effectStartDate.replace(/-/, "/").replace(/-/, "/");
											var nowTime = new Date().getTime();
											var effectStartTime = new Date(effectStartDate + ' 00:00:00').getTime();
											var effectEndTime = new Date(effectEndDate + ' 23:59:59').getTime();
											var nowString = new Date();
											var nowYear = nowString.getFullYear();
											var nowMonth = nowString.getMonth() + 1;
											var nowDay = nowString.getDate();
											var useStartTime = nowYear + '/' + nowMonth + '/' + nowDay + ' ' + value.useStartTime;
											useStartTime = new Date(useStartTime).getTime();
											var useEndTime = nowYear + '/' + nowMonth + '/' + nowDay + ' ' + value.useEndTime;
											useEndTime = new Date(useEndTime).getTime();
											if(value.useStatus == '0' && effectStartTime <= nowTime && effectEndTime >= nowTime && useStartTime <= nowTime && useEndTime >= nowTime){
												if(useCoupons < couponsCount){
													useCoupons += 1;
												}
											}
										})
										console.log(useCoupons);
										var couponsMoney = useCoupons * singlePrice;
										couponsMoney = couponsMoney > ac ? ac : couponsMoney;
										var refundMoney = re*1 + couponsMoney*1;
										if(ac == 0){
											refundString();		
										}else if(couponsMoney == 0){
											refundString();	
										}else{
											var str = '<div style="padding: 10px;">';
											if(user.phone){
												str += '<div style="margin-top: 5px;">手机号：'+user.phone+'</div> ';
											}
											str += '<div style="margin-top: 5px;">船型：'+bikeType+'</div>';
											str += '<div style="margin-top: 5px;">开始时间：'+order.ridingStartTime+'</div>';
											str += '<div style="margin-top: 5px;">结束时间：'+order.ridingEndTime+'</div>';
											str += '<div style="margin-top: 5px;">押金：'+de+'元</div>';
											str += '<div style="margin-top: 5px;">消费：'+ac+'元</div>';
											str += '<div style="margin-top: 5px;">剩余退款：'+refundMoney+'元</div>';
											str += '<div style="margin-top: 5px;">(优惠券已抵扣消费'+couponsMoney+'元)</div> </div>';
											$('.searchView').append(str);
											$('.search-btn').show();
										}
									}else{
										refundString();						
									}
								}else{
									refundString();
								}
								
								function refundString(){
									var str = '<div style="padding: 10px;">';
									if(user.phone){
										str += '<div style="margin-top: 5px;">手机号：'+user.phone+'</div> ';
									}
									str += '<div style="margin-top: 5px;">船型：'+bikeType+'</div>';
									str += '<div style="margin-top: 5px;">开始时间：'+order.ridingStartTime+'</div>';
									str += '<div style="margin-top: 5px;">结束时间：'+order.ridingEndTime+'</div>';
									str += '<div style="margin-top: 5px;">押金：'+de+'元</div>';
									str += '<div style="margin-top: 5px;">消费：'+ac+'元</div>';
									str += '<div style="margin-top: 5px;">剩余退款：'+re+'元</div> </div>';
									$('.searchView').append(str);
									$('.search-btn').show();
								}
							})
							
						}else{
							$('.coupons').hide();
							var dataMsg = data.msg;
							if(dataMsg == '您的手机号没有可退款的订单'){
								dataMsg = '<font>1、如果您已点击过"申请退款", 您的押金扣除消费后将原路退回</font><br>2、您的微信号暂时没有可退订单';
							}
							var str = '<p class="notice">' + dataMsg + '</p>';
							$('.searchView').append(str);
							$('.search-btn').hide();
							return;
						}
					}
				});
			}
			
			
			function searchClick(){
				var openDate = parseInt(app.getCookie('openDate'));
				var nowDate = new Date().getTime();
				if(openDate){
					var overdue = nowDate - openDate;
					if(overdue > 60*3*1000){
						layer.alert('二维码已失效，请您重新扫码');
						return;
					}
				}
				if(click){
					var userPhone = refundData.phone;
					click = false;
					app.getAjax('couponsOrder/user/getList', {
						phone: userPhone
					}, function(res){
						// 消费金额
						var ac = refundData.actualConsumeMoney;
						// 押金
						var de = refundData.normalDeposit;
						var singlePrice = priceData.price;
						var couponsCount = Math.ceil(ac / singlePrice);
						var couponsList = res.data;
						var useCoupons = [];
						couponsList.forEach(function(value, key){
							var effectEndDate = value.effectEndDate;
							effectEndDate = effectEndDate.replace(/-/, "/").replace(/-/, "/");
							var effectStartDate = value.effectStartDate;
							effectStartDate = effectStartDate.replace(/-/, "/").replace(/-/, "/");
							var nowTime = new Date().getTime();
							var effectStartTime = new Date(effectStartDate + ' 00:00:00').getTime();
							var effectEndTime = new Date(effectEndDate + ' 23:59:59').getTime();
							var nowString = new Date();
							var nowYear = nowString.getFullYear();
							var nowMonth = nowString.getMonth() + 1;
							var nowDay = nowString.getDate();
							var useStartTime = nowYear + '/' + nowMonth + '/' + nowDay + ' ' + value.useStartTime;
							useStartTime = new Date(useStartTime).getTime();
							var useEndTime = nowYear + '/' + nowMonth + '/' + nowDay + ' ' + value.useEndTime;
							useEndTime = new Date(useEndTime).getTime();
							
							if(value.useStatus == '0' && effectStartTime <= nowTime && effectEndTime >= nowTime && useStartTime <= nowTime && useEndTime >= nowTime){
								if(useCoupons.length < couponsCount){
									useCoupons.push({
										couponsId: value.id,
										orderId: refundData.id,
										useType: '1'
									});
								}
							}
							console.log(useCoupons);
						})
						if(useCoupons.length > 0){
							if(ac == 0){
								// 消费金额为0
								layer.msg('退款中，请稍后...', {
								  icon: 16,
								  shade: 0.01,
								  time: false
								});
								$.ajax({
									type:"post",
									url:host + 'ylhpark/devicePosLeaseApp/webRefund',
									contentType:"application/json",
									data: JSON.stringify(refundData),
									success: function(data){
										layer.alert(data.msg);
										setTimeout(function(){
											getRefundInfo(host);
										}, 2000);
									}
								});
							}else{
								layer.msg('退款中，请勿关闭页面...', {
								  icon: 16,
								  shade: 0.01,
								  time: false
								});
								$.ajax({
									type:"post",
									url:host + 'ylhpark/devicePosLeaseApp/webRefund',
									contentType:"application/json",
									data: JSON.stringify(refundData),
									success: function(data){
										if(data.msg == '退款成功'){
											var couponsNumber = useCoupons.length;
											var couponsMoney = singlePrice*couponsNumber;
											couponsMoney = couponsMoney > ac  ? ac : couponsMoney;
											app.postAjax('deviceOrderWeb/refundMoney', {
												orderId: data.data.order.id,
												refundMoney: couponsMoney
											}, function(res){
												app.postAjax('couponsOrder/use', {
													uses: useCoupons
												}, function(res){
													layer.alert(data.msg);
													setTimeout(function(){
														getRefundInfo(host);
													}, 2000);
												})
											})
										}else{
											layer.alert(data.msg);
										}
									}
								});
							}
						}else{
							layer.msg('退款中，请稍后...', {
							  icon: 16,
							  shade: 0.01,
							  time: false
							});
							$.ajax({
								type:"post",
								url:host + 'ylhpark/devicePosLeaseApp/webRefund',
								contentType:"application/json",
								data: JSON.stringify(refundData),
								success: function(data){
									layer.alert(data.msg);
									setTimeout(function(){
										getRefundInfo(host);
									}, 2000);
								}
							});
						}
					})
				}
			}
		</script>
	</body>
</html>
